<!DOCTYPE html>
<html>
<head>
    <title>Space Battle - Modern Shooter</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="full-screen" content="yes">
    
    <!-- App Icons -->
    <link rel="shortcut icon" href="./images/logo/favicon.ico" />
    <link rel="icon" type="image/x-icon" href="./images/logo/favicon.ico" />
    <link rel="apple-touch-icon" href="./images/logo/logo_large.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="./images/logo/logo_small.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="./images/logo/logo_small.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="./images/logo/logo_small.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="./images/logo/logo_large.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="./images/logo/logo_large.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="./images/logo/logo_large.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="./images/logo/logo_large.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="./images/logo/logo_large.png" />
    <link rel="icon" sizes="480x660" href="./images/logo/player_ship_icon_480x660.png" />
    <link rel="icon" sizes="512x512" href="./images/logo/player_ship_icon_512x512.png" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Arial', sans-serif;
            position: fixed;
            -webkit-overflow-scrolling: touch;
            margin: 0;
            padding: 0;
            /* Mobile fullscreen support */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Enhanced fullscreen support for mobile - fixes gaps */
        html:fullscreen, html:-webkit-full-screen, html:-moz-full-screen, html:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        body:fullscreen, body:-webkit-full-screen, body:-moz-full-screen, body:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }

        /* Mobile-specific fullscreen fixes */
        @media screen and (max-width: 768px) {
            html:fullscreen, html:-webkit-full-screen {
                width: 100vw !important;
                height: 100vh !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
            }
            
            body:fullscreen, body:-webkit-full-screen {
                width: 100vw !important;
                height: 100vh !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
            }
        }
        
        /* Force everything to landscape - hide all content in portrait */
        @media screen and (orientation: portrait) {
            body {
                overflow: hidden;
            }
            
            #loadingScreen,
            #menuOverlay,
            #gameSection {
                display: none !important;
            }
            
            body::before {
                content: "ðŸ”„";
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 80px;
                animation: rotate360 2s linear infinite;
            }
            
            body::after {
                content: "Please rotate your device";
                position: fixed;
                top: 60%;
                left: 50%;
                transform: translateX(-50%);
                color: #fff;
                font-size: 18px;
                text-align: center;
                width: 80%;
            }
            }
            
            @keyframes rotate360 {
                from { transform: translate(-50%, -50%) rotate(0deg); }
                to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }

        #loadingScreen.loaded {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-size: 1.5rem;
            color: #00ff88;
            margin-bottom: 0.6rem;
            text-shadow: 0 0 20px #00ff88;
        }

        .loading-text {
            color: #fff;
            font-size: 0.8rem;
            margin-bottom: 0.6rem;
            text-align: center;
        }

        .loading-progress {
            width: 50%;
            max-width: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .loading-progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-percentage {
            color: #00ff88;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Menu Overlay */
        #menuOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .menu-content {
            text-align: center;
            color: #fff;
            max-width: 500px;
            width: 90%;
        }

        .game-title {
            font-size: 1.2rem;
            color: #00ff88;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px #00ff88;
        }
        
        .menu-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
            width: 100%;
            max-width: 360px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .menu-btn {
            background: linear-gradient(45deg, #00ff88, #00ccff);
            border: none;
            color: #000;
            padding: 8px 10px;
            font-size: 0.72rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            width: 100%;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .menu-btn:active {
            transform: translateY(0);
        }

        /* Game Section */
        #gameSection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: none;
            z-index: 5;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #gameSection.active {
            display: block;
        }

        #gameCanvas {
            width: 100vw;
            height: 100vh;
            display: block;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            max-width: 100%;
            max-height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            margin: 0;
            padding: 0;
        }

        /* Game UI */
        #gameUI {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ff88;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff88;
        }

        .game-hud.right {
            left: auto;
            right: 20px;
        }

        .health-bar {
            position: absolute;
            top: 12px;
            left: 12px;
            width: clamp(140px, 30vw, 200px);
            height: 14px;
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid #ff0000;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.4);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #00ff00);
            transition: width 0.3s ease;
        }

        .score {
            position: absolute;
            top: 12px;
            right: 12px;
            color: #00ff88;
            font-size: 0.85rem;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff88;
        }

        .level {
            position: absolute;
            top: 42px;
            left: 12px;
            color: #ffaa00;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 0 0 10px #ffaa00;
        }

        .enemies-left {
            position: absolute;
            top: 40px;
            right: 12px;
            color: #ff00ff;
            font-size: 0.7rem;
            font-weight: bold;
            text-shadow: 0 0 10px #ff00ff;
        }


        /* Control Buttons */
        .control-btn {
            position: fixed;
            bottom: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 255, 136, 0.8);
            color: #000;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
        }

        .fullscreen-btn {
            left: 20px;
        }

        .close-btn {
            right: 20px;
        }

        /* Fullscreen button stays within fullscreen area */
        #gameSection:fullscreen .control-btn,
        #gameSection:-webkit-full-screen .control-btn,
        #gameSection:-moz-full-screen .control-btn,
        #gameSection:-ms-fullscreen .control-btn {
            position: fixed !important;
            z-index: 1000 !important;
        }

        /* Ensure buttons are visible in fullscreen */
        html:fullscreen .control-btn,
        html:-webkit-full-screen .control-btn,
        html:-moz-full-screen .control-btn,
        html:-ms-fullscreen .control-btn {
            position: fixed !important;
            z-index: 1000 !important;
        }

        .control-btn:hover {
            background: rgba(0, 255, 136, 1);
            transform: scale(1.1);
        }

        .btn-icon {
            display: block;
            font-size: 1.2rem;
        }

        /* Responsive Design */
        @media screen and (max-width: 768px) {
            .game-title {
                font-size: 1rem;
            }

            .menu-btn {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }

        /* Landscape Mode Optimizations */
        @media screen and (orientation: landscape) {
            .loading-logo {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }

            .loading-text {
                font-size: 0.7rem;
                margin-bottom: 0.5rem;
            }

            .loading-progress {
                width: 40%;
                max-width: 150px;
                margin-bottom: 0.4rem;
            }

            .loading-percentage {
                font-size: 0.6rem;
            }
        }

        /* Extra Small Devices */
        @media screen and (max-width: 480px) {
            .game-title {
                font-size: 0.9rem;
            }

            .menu-btn {
                padding: 5px 10px;
                font-size: 0.6rem;
            }

            .score {
                font-size: 0.7rem;
            }

            .level {
                font-size: 0.6rem;
            }

            .enemies-left {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-logo">ðŸš€</div>
        <div class="loading-text">Space Battle</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingBar"></div>
        </div>
        <div class="loading-percentage" id="loadingPercentage">0%</div>
    </div>

    <!-- Menu Overlay -->
    <div id="menuOverlay">
        <div class="menu-content" id="menuContainer">
            <!-- Menu content will be loaded here -->
        </div>
    </div>

    <!-- Game Section -->
    <section id="gameSection">
        <canvas id="gameCanvas"></canvas>

        <!-- Game UI -->
        <div id="gameUI">
            <div class="health-bar">
                <div class="health-fill" id="healthFill"></div>
            </div>
            <div class="score" id="score">Score: 0</div>
            <div class="level" id="level">Level: 1</div>
            <div class="enemies-left" id="enemiesLeft">Enemies: 0</div>
        </div>

        <!-- Control Buttons -->
        <!-- FIXED: Removed resize/fullscreen button as it's not working and not needed -->
        <button id="closeBtn" class="control-btn close-btn" onclick="closeGame()" title="Home">
            <span class="btn-icon">âœ•</span>
        </button>
    </section>

    <script>
        console.log("Space Battle Smartphone - Modern Game Version 2.0 Initialized");
        console.log("Level Progression System Active - Enemy Ships");

        // Force landscape orientation
        function lockOrientation() {
            try {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').then(
                        function() { console.log("Space Battle: Orientation locked to landscape"); },
                        function(error) { console.log("Space Battle: Orientation lock failed:", error); }
                    );
                } else if (screen.lockOrientation) {
                    screen.lockOrientation('landscape');
                    console.log("Space Battle: Orientation locked (legacy API)");
                } else if (screen.mozLockOrientation) {
                    screen.mozLockOrientation('landscape');
                    console.log("Space Battle: Orientation locked (Mozilla)");
                } else if (screen.msLockOrientation) {
                    screen.msLockOrientation('landscape');
                    console.log("Space Battle: Orientation locked (MS)");
                } else {
                    console.log("Space Battle: Screen orientation lock not supported");
                }
            } catch (error) {
                console.log("Space Battle: Error locking orientation:", error);
            }
        }

        // Global function to lock orientation
        window.lockGameOrientation = lockOrientation;

        window.addEventListener('load', function() {
            console.log("Space Battle - Page Loaded");

            // Lock orientation immediately on page load
            lockOrientation();

            // Progressive loading with percentage
            let loadingProgress = 0;
            const loadingBar = document.getElementById('loadingBar');
            const loadingPercentage = document.getElementById('loadingPercentage');

            const loadingInterval = setInterval(function() {
                loadingProgress += Math.random() * 15;
                if (loadingProgress > 100) loadingProgress = 100;

                if (loadingBar && loadingPercentage) {
                    loadingBar.style.width = loadingProgress + '%';
                    loadingPercentage.textContent = Math.floor(loadingProgress) + '%';
                }

                if (loadingProgress >= 100) {
                    clearInterval(loadingInterval);
                    setTimeout(function() {
                        const loadingScreen = document.getElementById('loadingScreen');
                        if (loadingScreen) {
                            loadingScreen.classList.add('loaded');
                            console.log("Space Battle: Loading complete - 100%");
                        }
                    }, 500);
                }
            }, 100);

            // Initialize menu after loading
            setTimeout(function() {
                MenuUI.init();
            }, 1000);
        });

        // Modern HTML/CSS UI - Complete Menu System
        const MenuUI = {
            overlay: null,
            container: null,
            currentScreen: 'main',
            _confirmEl: null,
            
            init: function() {
                console.log("Space Battle: Initializing Modern Menu System");
                this.overlay = document.getElementById('menuOverlay');
                this.container = document.getElementById('menuContainer');
                if (this.overlay && this.container) {
                    this.showMainMenu();
                    console.log("Space Battle: Menu system initialized successfully");
                } else {
                    console.log("Space Battle: Menu elements not found");
                }
            },
            
            showMainMenu: function() {
                console.log("Space Battle: Showing main menu");
                this.currentScreen = 'main';
                if (this.container) {
                    this.container.innerHTML = `
                        <h1 class="game-title">SPACE BATTLE</h1>
                        <p class="menu-subtitle">MODERN SPACE SHOOTER</p>
                        <div class="menu-buttons">
                            <button type="button" class="menu-btn start" onclick="event.preventDefault(); MenuUI.startGame(); return false;">Start Game</button>
                            <button type="button" class="menu-btn options" onclick="event.preventDefault(); MenuUI.showOptions(); return false;">Options</button>
                            <button type="button" class="menu-btn stats" onclick="event.preventDefault(); MenuUI.showStats(); return false;">Statistics</button>
                            <button type="button" class="menu-btn help" onclick="event.preventDefault(); MenuUI.showHelp(); return false;">Help</button>
                        </div>
                    `;
                    
                    // Force buttons to be clickable in fullscreen
                    setTimeout(() => {
                        const menuButtons = this.container.querySelectorAll('.menu-btn');
                        menuButtons.forEach(btn => {
                            btn.style.zIndex = '1000001';
                            btn.style.position = 'relative';
                            btn.style.pointerEvents = 'auto';
                            btn.style.cursor = 'pointer';
                        });
                    }, 100);
                }
            },

            showInGameMenu: function() {
                console.log("Space Battle: Showing in-game menu");
                this.currentScreen = 'ingame';
                if (this.container) {
                    this.container.innerHTML = `
                        <h1 class="game-title">SPACE BATTLE</h1>
                        <p class="menu-subtitle">MODERN SPACE SHOOTER</p>
                        <div class="menu-buttons">
                            <button type="button" class="menu-btn start" onclick="event.preventDefault(); MenuUI.restartGame(); return false;">Restart Game</button>
                            <button type="button" class="menu-btn options" onclick="event.preventDefault(); MenuUI.showOptions(); return false;">Options</button>
                            <button type="button" class="menu-btn stats" onclick="event.preventDefault(); MenuUI.showStats(); return false;">Statistics</button>
                            <button type="button" class="menu-btn help" onclick="event.preventDefault(); MenuUI.showHelp(); return false;">Help</button>
                        </div>
                        <button onclick="MenuUI.hideInGameMenu()" style="position: fixed; bottom: 20px; left: 20px; background: rgba(255, 100, 100, 0.9); border: none; color: #fff; border-radius: 50%; cursor: pointer; font-size: 1.5rem; width: 50px; height: 50px; z-index: 1000002; display: flex; align-items: center; justify-content: center; padding: 0;">âœ•</button>
                    `;
                    
                    // Force buttons to be clickable in fullscreen
                    setTimeout(() => {
                        const menuButtons = this.container.querySelectorAll('.menu-btn');
                        menuButtons.forEach(btn => {
                            btn.style.zIndex = '1000001';
                            btn.style.position = 'relative';
                            btn.style.pointerEvents = 'auto';
                            btn.style.cursor = 'pointer';
                        });
                    }, 100);
                }
            },

            hideInGameMenu: function() {
                console.log("Space Battle: Hiding in-game menu");
                const menuOverlay = document.getElementById('menuOverlay');
                const gameSection = document.getElementById('gameSection');

                // If the menu was opened from gameplay, resume gameplay
                if (window.wasGameRunningBeforeMenu) {
                    if (menuOverlay) {
                        menuOverlay.style.display = 'none';
                    }
                    if (gameSection) {
                        gameSection.style.display = 'block';
                        // Re-enter fullscreen if it was exited
                        setTimeout(() => {
                            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement ||
                                document.mozFullScreenElement || document.msFullscreenElement);
                            if (!isFullscreen) {
                                if (gameSection.requestFullscreen) {
                                    gameSection.requestFullscreen().catch(err => {});
                                } else if (gameSection.webkitRequestFullscreen) {
                                    gameSection.webkitRequestFullscreen().catch(err => {});
                                } else if (gameSection.mozRequestFullScreen) {
                                    gameSection.mozRequestFullScreen().catch(err => {});
                                } else if (gameSection.msRequestFullscreen) {
                                    gameSection.msRequestFullscreen().catch(err => {});
                                }
                            }
                        }, 100);
                        // Resume game
                        if (window.game) {
                            window.game.gameRunning = true;
                            window.game.gameLoop();
                        }
                    }
                    // Reset flag
                    window.wasGameRunningBeforeMenu = false;
                    return;
                }

                // If game hasn't started, return to main menu (keep overlay visible)
                if (menuOverlay) {
                    menuOverlay.style.display = 'flex';
                }
                if (gameSection) {
                    gameSection.style.display = 'none';
                }
                this.showMainMenu();
            },
            
            showOptions: function() {
                console.log("Space Battle: Showing options");
                this.currentScreen = 'options';
                if (this.container) {
                    // Music removed for smartphone version - only SFX toggle remains
                    const sfxState = localStorage.getItem('sfx') === 'true' ? 'OFF' : 'ON';

                    this.container.innerHTML = `
                        <h1 class="game-title" style="color: #ffaa00;">OPTIONS</h1>
                        <div class="menu-buttons" style="display: flex; justify-content: center; align-items: center; margin-top: 1rem;">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 12px;">
                                <span style="color: #fff; font-size: 0.9rem;">Sound FX:</span>
                                <button type="button" class="menu-btn" onclick="event.preventDefault(); MenuUI.toggleSFX(this); return false;" style="width: 90px; padding: 6px; font-size: 0.8rem;">
                                    ${sfxState}
                                </button>
                            </div>
                        </div>
                        <button onclick="MenuUI.hideInGameMenu()" style="position: fixed; bottom: 20px; left: 20px; background: rgba(255, 100, 100, 0.9); border: none; color: #fff; border-radius: 50%; cursor: pointer; font-size: 1.5rem; width: 50px; height: 50px; z-index: 1000002; display: flex; align-items: center; justify-content: center; padding: 0;">âœ•</button>
                    `;
                }
            },
            
            showStats: function() {
                console.log("=== SHOWING STATISTICS ===");
                this.currentScreen = 'stats';
                if (this.container) {
                    const highScore = localStorage.getItem('highScore') || '0';
                    const totalEnemiesKilled = localStorage.getItem('totalEnemiesKilled') || '0';
                    const bestLevel = localStorage.getItem('bestLevel') || '0';
                    const hasStats = (highScore !== '0' || totalEnemiesKilled !== '0' || bestLevel !== '0');

                    console.log(`Displaying statistics:`);
                    console.log(`High Score: ${highScore}`);
                    console.log(`Total Enemies Killed: ${totalEnemiesKilled}`);
                    console.log(`Best Level: ${bestLevel}`);
                    console.log("=== END SHOWING STATISTICS ===");

                    this.container.innerHTML = `
                        <h1 class="game-title" style="color: #00aaff;">STATISTICS</h1>
                        <div style="text-align: left; margin: 1rem 0; color: #fff; max-height: 50vh; overflow-y: auto; padding: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin: 0.4rem 0; padding: 4px; background: rgba(255,255,255,0.1); border-radius: 3px; font-size: 0.7rem;">
                                <span>High Score:</span>
                                <span style="color: #ffaa00; font-weight: bold;">${highScore}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 0.4rem 0; padding: 4px; background: rgba(255,255,255,0.1); border-radius: 3px; font-size: 0.7rem;">
                                <span>Enemies Killed:</span>
                                <span style="color: #ff00ff; font-weight: bold;">${totalEnemiesKilled}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 0.4rem 0; padding: 4px; background: rgba(255,255,255,0.1); border-radius: 3px; font-size: 0.7rem;">
                                <span>Best Level:</span>
                                <span style="color: #ffff00; font-weight: bold;">${bestLevel}</span>
                            </div>
                        </div>
                        <div class="menu-buttons" style="display: flex; justify-content: center; align-items: center;">
                            <button
                                type="button"
                                class="menu-btn"
                                onclick="event.preventDefault(); MenuUI.resetStats(); return false;"
                                style="max-width: 200px; width: auto; ${hasStats ? '' : 'opacity:0.4; cursor:not-allowed; pointer-events:none;'}"
                            >
                                Reset Stats
                            </button>
                        </div>
                        <button onclick="MenuUI.hideInGameMenu()" style="position: fixed; bottom: 20px; left: 20px; background: rgba(255, 100, 100, 0.9); border: none; color: #fff; border-radius: 50%; cursor: pointer; font-size: 1.5rem; width: 50px; height: 50px; z-index: 1000002; display: flex; align-items: center; justify-content: center; padding: 0;">âœ•</button>
                    `;
                }
            },

            // Rewarded confirmation modal
            showRewardedConfirm: function(message, onYes, onNo) {
                if (!this.overlay) { this.overlay = document.getElementById('menuOverlay'); }
                if (!this.container) { this.container = document.getElementById('menuContainer'); }

                if (this.overlay) {
                    this.overlay.style.display = 'flex';
                }

                // Build lightweight confirmation element
                if (!this._confirmEl) {
                    this._confirmEl = document.createElement('div');
                    this._confirmEl.style.position = 'fixed';
                    this._confirmEl.style.left = '50%';
                    this._confirmEl.style.top = '50%';
                    this._confirmEl.style.transform = 'translate(-50%, -50%)';
                    this._confirmEl.style.zIndex = '1000003';
                    this._confirmEl.style.background = 'rgba(0,0,0,0.85)';
                    this._confirmEl.style.border = '1px solid rgba(255,255,255,0.15)';
                    this._confirmEl.style.boxShadow = '0 8px 30px rgba(0,0,0,0.5)';
                    this._confirmEl.style.borderRadius = '10px';
                    this._confirmEl.style.padding = '16px';
                    this._confirmEl.style.width = '80%';
                    this._confirmEl.style.maxWidth = '360px';
                    this._confirmEl.style.color = '#fff';

                    const text = document.createElement('div');
                    text.style.fontSize = '0.9rem';
                    text.style.textAlign = 'center';
                    text.style.marginBottom = '12px';
                    text.id = 'rvConfirmText';
                    this._confirmEl.appendChild(text);

                    const btnRow = document.createElement('div');
                    btnRow.style.display = 'flex';
                    btnRow.style.gap = '10px';
                    btnRow.style.justifyContent = 'center';

                    const yesBtn = document.createElement('button');
                    yesBtn.textContent = 'YES';
                    yesBtn.style.background = 'linear-gradient(45deg, #00ff88, #00ccff)';
                    yesBtn.style.color = '#000';
                    yesBtn.style.border = 'none';
                    yesBtn.style.borderRadius = '6px';
                    yesBtn.style.padding = '10px 16px';
                    yesBtn.style.fontWeight = 'bold';
                    yesBtn.style.cursor = 'pointer';

                    const noBtn = document.createElement('button');
                    noBtn.textContent = 'NO';
                    noBtn.style.background = 'rgba(255,255,255,0.1)';
                    noBtn.style.color = '#fff';
                    noBtn.style.border = '1px solid rgba(255,255,255,0.2)';
                    noBtn.style.borderRadius = '6px';
                    noBtn.style.padding = '10px 16px';
                    noBtn.style.cursor = 'pointer';

                    btnRow.appendChild(yesBtn);
                    btnRow.appendChild(noBtn);
                    this._confirmEl.appendChild(btnRow);

                    document.body.appendChild(this._confirmEl);

                    yesBtn.addEventListener('click', () => {
                        this._confirmEl.style.display = 'none';
                        try { if (typeof onYes === 'function') { onYes(); } } catch(e) {}
                    });
                }

                // Update NO button handler each time (to support dynamic onNo)
                const noBtn = this._confirmEl.querySelector('button:last-child');
                if (noBtn) {
                    noBtn.onclick = () => {
                        this._confirmEl.style.display = 'none';
                        try { if (typeof onNo === 'function') { onNo(); } } catch(e) {}
                    };
                }

                const msgEl = this._confirmEl.querySelector('#rvConfirmText');
                if (msgEl) { msgEl.textContent = message || 'Watch a video to continue?'; }
                this._confirmEl.style.display = 'block';
            },

            // Helper to trigger rewarded via confirmation
            requestRewarded: function(message, onNo) {
                this.showRewardedConfirm(message || 'Watch a video to get extra life?', function() {
                    try { showAdRewarded(); } catch(e) {}
                }, onNo);
            },
            
            showHelp: function() {
                console.log("Space Battle: Showing help");
                this.currentScreen = 'help';
                if (this.container) {
                    this.container.innerHTML = `
                        <h1 class="game-title" style="color: #ff00ff; font-size: clamp(0.8rem, 2.8vw, 0.95rem); margin-bottom: clamp(0.25rem, 2vw, 0.4rem);">HOW TO PLAY</h1>
                        <div style="text-align: left; margin: clamp(0.25rem, 2.5vw, 0.4rem) 0; color: #fff; font-size: clamp(0.54rem, 2.4vw, 0.7rem); line-height: 1.35; padding: clamp(0.35rem, 2.5vw, 0.55rem); border-radius: 6px; background: rgba(255,255,255,0.05);">
                            <p style="margin-bottom: clamp(0.25rem, 2vw, 0.4rem);"><strong style="color: #FFD700; font-size: clamp(0.65rem, 2.6vw, 0.78rem);">ðŸŽ® Controls</strong><br>
                            â€¢ Drag to steer<br>
                            â€¢ Tap to fire<br>
                            â€¢ Dodge ships & lasers</p>

                            <p style="margin-bottom: clamp(0.25rem, 2vw, 0.4rem);"><strong style="color: #FFD700; font-size: clamp(0.65rem, 2.6vw, 0.78rem);">ðŸ“Š Levels</strong><br>
                            â€¢ Level 1: 6 enemies<br>
                            â€¢ Level 2: 12 enemies<br>
                            â€¢ Level 3: 24 enemies<br>
                            â€¢ Escaped foes still count</p>

                            <p style="margin-bottom: 0;"><strong style="color: #FFD700; font-size: clamp(0.65rem, 2.6vw, 0.78rem);">ðŸ’¥ Tips</strong><br>
                            â€¢ Use landscape fullscreen<br>
                            â€¢ Grab power-ups quickly<br>
                            â€¢ Expect faster waves</p>
                        </div>
                        <div class="menu-buttons">
                        </div>
                        <button onclick="MenuUI.hideInGameMenu()" style="position: fixed; bottom: 20px; left: 20px; background: rgba(255, 100, 100, 0.9); border: none; color: #fff; border-radius: 50%; cursor: pointer; font-size: 1.5rem; width: 50px; height: 50px; z-index: 1000002; display: flex; align-items: center; justify-content: center; padding: 0;">âœ•</button>
                    `;
                }
            },

            startGame: function() {
                console.log("Space Battle: Starting game");
                // Hide banner when game starts
                try{ hideBanner(); }catch(e){}
                
                // Cache ads at start game (mid-roll and rewarded)
                gameCacheAd();
                console.log("Space Battle: Ads caching at game start (mid-roll + rewarded)");
                
                this.overlay.style.display = 'none';
                const gameSection = document.getElementById('gameSection');
                if (gameSection) {
                    gameSection.classList.add('active');
                    gameSection.style.display = 'block';
                }
                startNewGame();

                // Immediately show in-game menu once the game starts (overlay on top of gameplay)
                setTimeout(() => {
                    if (typeof MenuUI !== 'undefined' && MenuUI && MenuUI.showInGameMenu) {
                        MenuUI.showInGameMenu();
                    }
                }, 150);
            },

            restartGame: function() {
                console.log("Space Battle: Restarting game");
                
                // Cache ads at restart game (mid-roll and rewarded)
                gameCacheAd();
                console.log("Space Battle: Ads caching at game restart (mid-roll + rewarded)");
                
                this.overlay.style.display = 'none';
                const gameSection = document.getElementById('gameSection');
                if (gameSection) {
                    gameSection.classList.add('active');
                    gameSection.style.display = 'block';
                    
                    // Re-enter fullscreen if it was exited
                    setTimeout(() => {
                        const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                             document.mozFullScreenElement || document.msFullscreenElement);
                        
                        if (!isFullscreen) {
                            // Re-enter fullscreen
                            if (gameSection.requestFullscreen) {
                                gameSection.requestFullscreen().catch(err => {});
                            } else if (gameSection.webkitRequestFullscreen) {
                                gameSection.webkitRequestFullscreen().catch(err => {});
                            } else if (gameSection.mozRequestFullScreen) {
                                gameSection.mozRequestFullScreen().catch(err => {});
                            } else if (gameSection.msRequestFullscreen) {
                                gameSection.msRequestFullscreen().catch(err => {});
                            }
                        }
                    }, 100);
                }
                
                startNewGame();
            },

            toggleMusic: function(button) {
                // FIXED: Button text shows what will happen when clicked
                // Button "ON" click â†’ Music ON à¤¹à¥‹à¤—à¤¾, button "OFF" à¤¹à¥‹ à¤œà¤¾à¤à¤—à¤¾
                // Button "OFF" click â†’ Music OFF à¤¹à¥‹à¤—à¤¾, button "ON" à¤¹à¥‹ à¤œà¤¾à¤à¤—à¤¾
                const currentButtonText = button.textContent.trim();
                
                if (currentButtonText === 'ON') {
                    // Button shows "ON" - clicking will turn music ON, button becomes "OFF"
                    button.textContent = 'OFF';
                    localStorage.setItem('music', 'true');
                    if (window.game) {
                        window.game.muteMusic = false;
                        window.game.playMusic();
                        console.log("Music turned ON");
                    }
                } else {
                    // Button shows "OFF" - clicking will turn music OFF, button becomes "ON"
                    button.textContent = 'ON';
                    localStorage.setItem('music', 'false');
                    if (window.game) {
                        window.game.muteMusic = true;
                        window.game.stopMusic();
                        console.log("Music turned OFF");
                    }
                }
            },

            toggleSFX: function(button) {
                // FIXED: Button text shows what will happen when clicked
                // Button "ON" click â†’ SFX ON à¤¹à¥‹à¤—à¤¾, button "OFF" à¤¹à¥‹ à¤œà¤¾à¤à¤—à¤¾
                // Button "OFF" click â†’ SFX OFF à¤¹à¥‹à¤—à¤¾, button "ON" à¤¹à¥‹ à¤œà¤¾à¤à¤—à¤¾
                const currentButtonText = button.textContent.trim();
                
                if (currentButtonText === 'ON') {
                    // Button shows "ON" - clicking will turn SFX ON, button becomes "OFF"
                    button.textContent = 'OFF';
                    localStorage.setItem('sfx', 'true');
                    if (window.game) {
                        window.game.muteSFX = false;
                        window.game.playSFX('select');
                        console.log("SFX turned ON");
                    }
                } else {
                    // Button shows "OFF" - clicking will turn SFX OFF, button becomes "ON"
                    button.textContent = 'ON';
                    localStorage.setItem('sfx', 'false');
                    if (window.game) {
                        window.game.muteSFX = true;
                        console.log("SFX turned OFF");
                    }
                }
            },
            
            resetStats: function() {
                // Read current stats
                const highScore = parseInt(localStorage.getItem('highScore') || '0');
                const totalEnemiesKilled = parseInt(localStorage.getItem('totalEnemiesKilled') || '0');
                const bestLevel = parseInt(localStorage.getItem('bestLevel') || '0');
                const hasStats = (highScore !== 0 || totalEnemiesKilled !== 0 || bestLevel !== 0);

                // If no stats, do nothing (button is already visually disabled)
                if (!hasStats) {
                    console.log("Space Battle: No statistics to reset");
                    return;
                }

                // Use existing overlay-based confirmation popup (no alert)
                MenuUI.showRewardedConfirm(
                    'Are you sure you want to reset all statistics?',
                    () => {
                        // YES â†’ reset stats
                        localStorage.removeItem('highScore');
                        localStorage.removeItem('gamesPlayed');
                        localStorage.removeItem('totalEnemiesKilled');
                        localStorage.removeItem('bestLevel');
                        
                        // Set default values
                        localStorage.setItem('highScore', '0');
                        localStorage.setItem('gamesPlayed', '0');
                        localStorage.setItem('totalEnemiesKilled', '0');
                        localStorage.setItem('bestLevel', '0');
                        
                        this.showStats();
                        console.log("Space Battle: Statistics reset after popup confirmation");
                    },
                    () => {
                        // NO â†’ just close popup
                        console.log("Space Battle: Statistics reset cancelled from popup");
                    }
                );
            },

            exitGame: function() {
                if (confirm('Are you sure you want to exit Space Battle?')) {
                    window.close();
                }
            }
        };

        // Complete Space Shooter Game with Level System
        class SpaceShooterGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');

                // Initialize canvas with proper responsive sizing
                this.initializeCanvas();

                // Game state
                this.gameRunning = false;
                this.score = 0;
                this.level = 1;
                this.health = 100;
                this.enemiesKilled = 0;
                this.totalEnemiesInLevel = 0;
                this.gameSpeed = 1.0; // Base speed multiplier

                // Game objects
                this.player = null;
                this.bullets = [];
                this.enemies = [];
                this.particles = [];
                this.powerups = [];

                // Input handling
                this.keys = {};
                this.mouseX = 0;
                this.mouseY = 0;
                this.mousePressed = false;

                // Game loop
                this.lastTime = 0;
                this.enemySpawnTimer = 0;
                this.powerupSpawnTimer = 0;

                // Sound settings
                // FIXED: Completely disable background music for smartphone version
                this.muteMusic = true;
                this.muteSFX = localStorage.getItem('sfx') === 'false';

                // Audio system
                this.audio = {
                    music: null,
                    sfx: {
                        shoot: null,
                        explosion: null,
                        levelUp: null,
                        death: null,
                        select: null,
                        pause: null
                    }
                };
                this.initializeAudio();

                this.setupEventListeners();
            }

            initializeCanvas() {
                // Set canvas size to fill the viewport reliably across rotations
                const rect = this.canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;

                // Prefer window inner size; rect can be 0 during orientation/visibility transitions
                let cssW = Math.max(rect.width || 0, window.innerWidth || 0, document.documentElement.clientWidth || 0);
                let cssH = Math.max(rect.height || 0, window.innerHeight || 0, document.documentElement.clientHeight || 0);

                // Fallback minimums to avoid zero-sized canvas on some devices mid-rotation
                if (cssW < 10 || cssH < 10) {
                    cssW = window.innerWidth || 360;
                    cssH = window.innerHeight || 640;
                }

                // Reset transforms to avoid cumulative scaling after rotations/resumes
                if (this.ctx && this.ctx.setTransform) {
                    this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                }

                // Apply CSS size first to let layout settle
                this.canvas.style.width = cssW + 'px';
                this.canvas.style.height = cssH + 'px';

                // Backing store size (device pixels)
                this.canvas.width = Math.round(cssW * dpr);
                this.canvas.height = Math.round(cssH * dpr);

                // Scale the drawing context so everything draws at the correct size
                this.ctx.scale(dpr, dpr);

                this.width = cssW;
                this.height = cssH;

                // Clear to black to avoid artifacts after orientation changes
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.width, this.height);

                // If the browser is still reporting tiny dims shortly after rotation, retry once
                if (this.width < 50 || this.height < 50) {
                    setTimeout(() => {
                        const rect2 = this.canvas.getBoundingClientRect();
                        if (rect2.width > this.width || rect2.height > this.height) {
                            this.initializeCanvas();
                            this.render();
                        }
                    }, 150);
                }
            }

            initializeAudio() {
                // Initialize background music
                this.audio.music = new Audio('sound/music/DST-DasElectron.mp3');
                this.audio.music.loop = true;
                this.audio.music.volume = 0.3;

                // Initialize sound effects
                this.audio.sfx.shoot = new Audio('sound/sfx/sfx_laser1.mp3');
                this.audio.sfx.shoot.volume = 0.5;
                
                this.audio.sfx.explosion = new Audio('sound/sfx/explosion.mp3');
                this.audio.sfx.explosion.volume = 0.6;
                
                this.audio.sfx.levelUp = new Audio('sound/sfx/levelUp.mp3');
                this.audio.sfx.levelUp.volume = 0.7;
                
                this.audio.sfx.death = new Audio('sound/sfx/death.mp3');
                this.audio.sfx.death.volume = 0.8;
                
                this.audio.sfx.select = new Audio('sound/sfx/select.mp3');
                this.audio.sfx.select.volume = 0.4;
                
                this.audio.sfx.pause = new Audio('sound/sfx/pause.mp3');
                this.audio.sfx.pause.volume = 0.5;

                // Start background music if not muted
                if (!this.muteMusic) {
                    this.playMusic();
                }
            }

            playMusic() {
                console.log("playMusic called - muteMusic:", this.muteMusic, "audio exists:", !!this.audio.music);
                if (!this.muteMusic && this.audio.music) {
                    console.log("Attempting to play music");
                    const audio = this.audio.music;
                    
                    // Force play by resetting and playing
                    audio.pause(); // Ensure we're paused
                    audio.currentTime = 0;
                    
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                console.log("Music started successfully");
                            })
                            .catch(error => {
                                console.log('Music play failed:', error);
                                // Try to reload and play again after a small delay
                                setTimeout(() => {
                                    audio.load();
                                    audio.play().catch(e => console.log('Retry play failed:', e));
                                }, 100);
                            });
                    }
                } else {
                    console.log("Music muted or no audio object");
                }
            }

            stopMusic() {
                if (this.audio.music) {
                    this.audio.music.pause();
                    this.audio.music.currentTime = 0;
                    // Don't call load() as it might cause issues
                }
            }

            // FIXED: Add pause/resume music functions for when game is minimized or ads are shown
            pauseMusic() {
                if (this.audio.music && !this.audio.music.paused) {
                    this.audio.music.pause();
                    console.log("Space Battle: Music paused (game minimized or ad shown)");
                }
            }

            resumeMusic() {
                if (this.audio.music && this.audio.music.paused && !this.muteMusic) {
                    this.audio.music.play().catch(e => console.log('Resume music failed:', e));
                    console.log("Space Battle: Music resumed (game active)");
                }
            }

            playSFX(soundName) {
                if (!this.muteSFX && this.audio.sfx[soundName]) {
                    // Reset to beginning and play
                    this.audio.sfx[soundName].currentTime = 0;
                    this.audio.sfx[soundName].play().catch(e => console.log('SFX play failed:', e));
                }
            }

            setupEventListeners() {
                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                    if (e.code === 'Escape') {
                        this.pauseGame();
                    }
                    // Test level completion with 'L' key
                    if (e.code === 'KeyL') {
                        console.log("Force completing level for testing...");
                        this.enemiesKilled = this.totalEnemiesInLevel;
                        this.checkLevelCompletion();
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });

                // Mouse events
                this.canvas.addEventListener('mousemove', (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.mouseX = e.clientX - rect.left;
                    this.mouseY = e.clientY - rect.top;
                });

                this.canvas.addEventListener('mousedown', (e) => {
                    this.mousePressed = true;
                });

                this.canvas.addEventListener('mouseup', (e) => {
                    this.mousePressed = false;
                });

                // Touch events
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const rect = this.canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    this.mouseX = touch.clientX - rect.left;
                    this.mouseY = touch.clientY - rect.top;
                });

                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.mousePressed = true;
                });

                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.mousePressed = false;
                });

                // Window resize
                window.addEventListener('resize', () => {
                    this.initializeCanvas();
                    // Redraw current frame to prevent temporary black frame
                    this.render();
                });

                // Handle device orientation changes explicitly
                window.addEventListener('orientationchange', () => {
                    // Give layout time to settle, then re-init; do a second pass as safety
                    setTimeout(() => {
                        this.initializeCanvas();
                        this.render();
                    }, 250);
                    setTimeout(() => {
                        this.initializeCanvas();
                        this.render();
                    }, 700);
                });

                // Handle tab/app visibility changes (calls, notifications)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        // FIXED: Pause music when game is minimized
                        this.pauseMusic();
                    } else {
                        // Reinitialize canvas when returning to app
                        this.initializeCanvas();
                        this.render();
                        // FIXED: Resume music when game becomes visible again
                        this.resumeMusic();
                    }
                });

                // Some mobile browsers fire pageshow after interruption
                window.addEventListener('pageshow', () => {
                    this.initializeCanvas();
                    this.render();
                });
            }

            // Canvas initialization is now handled in initializeCanvas()

            start() {
                console.log(`Space Battle: Starting Level ${this.level}`);
                
                // FIXED: Cache both ads on new game session (level 1) or new level start
                if (this.level === 1) {
                    // New game session - cache both ads
                    gameCacheAd();
                    console.log("Space Battle: New Game Start - Both ads caching");
                } else {
                    // New level - cache both ads for next level
                    gameCacheAd();
                    console.log("Space Battle: New Level Start - Both ads caching for next level");
                }
                
                this.gameRunning = true;
                // FIXED: Only reset score when starting a completely new game (level 1)
                // Score should persist between levels
                if (this.level === 1) {
                    this.score = 0;
                    this.health = 100;
                    this.enemiesKilled = 0;
                    this.totalEnemiesKilled = 0; // Track total enemies killed for mid-roll ad
                } else {
                    // For level transitions, only reset level-specific counters
                    this.enemiesKilled = 0;
                    this.totalEnemiesKilled = 0; // Reset for new level
                }
                
                // FIXED: Reset timers when starting a new level to prevent timing issues
                // This ensures clean state transitions and prevents game stuck issues
                this.lastTime = performance.now();
                this.enemySpawnTimer = 0;
                this.powerupSpawnTimer = 0;
                
                // Expose reward function globally for SDK
                window.grantRewardExtraHealth = () => {
                    try {
                        if (this && typeof this.health !== 'undefined') {
                            // FIXED: Remove all popups to prevent game stuck
                            const gameOverPopup = document.getElementById('gameOverPopup');
                            if (gameOverPopup) {
                                gameOverPopup.remove();
                            }
                            const rewardedPopup = document.getElementById('rewardedPopup');
                            if (rewardedPopup) {
                                rewardedPopup.remove();
                            }
                            
                            // Restore game state and continue
                            this.health = Math.min(this.health + 50, 100); // Add 50 health, cap at 100
                            this.gameRunning = true;
                            console.log("Space Battle: Reward granted - +50 health (total: " + this.health + ")");
                            this.updateUI();

                            // FIXED: Properly resume the main game loop after rewarded ad
                            // Reset timing and restart gameLoop so the game does not stay stuck on Game Over
                            this.lastTime = performance.now();
                            this.gameLoop(this.lastTime);
                            
                            console.log("Space Battle: Game continued with extra health - game loop restarted");
                        }
                    } catch(e) { 
                        console.error("Error in grantRewardExtraHealth:", e);
                        // FIXED: Ensure game doesn't get stuck even if there's an error
                        if (this) {
                            this.gameRunning = true;
                        }
                    }
                };

                // Clear arrays
                this.bullets = [];
                this.enemies = [];
                this.particles = [];
                this.powerups = [];

                // Calculate enemies for this level
                this.totalEnemiesInLevel = this.calculateEnemiesForLevel(this.level);
                console.log(`Level ${this.level}: Spawning ${this.totalEnemiesInLevel} enemies`);

                // Calculate speed multiplier
                this.gameSpeed = this.calculateSpeedMultiplier(this.level);
                console.log(`Level ${this.level}: Speed multiplier ${this.gameSpeed}x`);

                // Create player (on left side, centered vertically)
                this.player = new Player(50, this.height / 2, this.height);

                // Update UI
                this.updateUI();

                // Start game loop
                this.gameLoop();

                console.log("Space Battle: Game started successfully");
            }

            gameLoop(currentTime = 0) {
                if (!this.gameRunning) return;

                const deltaTime = currentTime - this.lastTime;
                this.lastTime = currentTime;

                this.update(deltaTime);
                this.render();

                requestAnimationFrame((time) => this.gameLoop(time));
            }

            update(deltaTime) {
                // Update player
                if (this.player) {
                    this.player.update(this.mouseX, this.mouseY, this.mousePressed, deltaTime);

                    // Create bullets (shoot from exact nose tip of rocket)
                    if (this.player.shooting) {
                        this.bullets.push(new Bullet(this.player.x + 55, this.player.y + 15));
                        this.playSFX('shoot');
                    }
                }

                // Update bullets
                this.bullets = this.bullets.filter(bullet => {
                    bullet.update(deltaTime);
                    return bullet.x < this.width + 10; // Remove bullets that go off right side
                });

                // Spawn enemies based on level requirements
                if (this.enemies.length < this.totalEnemiesInLevel) {
                    this.enemySpawnTimer += deltaTime;
                    const spawnInterval = 1000 / this.gameSpeed; // Faster spawning at higher levels

                    if (this.enemySpawnTimer > spawnInterval) {
                        this.spawnEnemy();
                        this.enemySpawnTimer = 0;
                    }
                }

                // Update enemies and track escaped ones
                this.enemies = this.enemies.filter(enemy => {
                    enemy.update(deltaTime);
                    const escaped = enemy.x < -50; // Escaped off left side

                    if (escaped) {
                        // Escaped enemies don't count for level progression or kills
                        console.log(`Enemy escaped: ${enemy.type} - not counted`);
                    }

                    return !escaped;
                });

                // Spawn powerups occasionally
                this.powerupSpawnTimer += deltaTime;
                if (this.powerupSpawnTimer > 8000) {
                    this.spawnPowerup();
                    this.powerupSpawnTimer = 0;
                }

                // Update powerups
                this.powerups = this.powerups.filter(powerup => {
                    powerup.update(deltaTime);
                    return powerup.x > -50; // Remove powerups that go off left side
                });

                // Update particles
                this.particles = this.particles.filter(particle => {
                    particle.update(deltaTime);
                    return particle.life > 0;
                });

                // Check collisions
                this.checkCollisions();

                // Update UI
                this.updateUI();

                // Check level completion
                this.checkLevelCompletion();
            }

            calculateEnemiesForLevel(level) {
                // Level progression: 6, 12, 24, 48, 96... (doubling each level)
                if (level === 1) return 6;
                return 6 * Math.pow(2, level - 1);
            }

            calculateSpeedMultiplier(level) {
                // Progressive speed increase with each level
                if (level >= 10) return 3.0; // 300% faster
                if (level >= 8) return 2.5;   // 250% faster
                if (level >= 6) return 2.0;   // 200% faster
                if (level >= 4) return 1.5;  // 150% faster
                if (level >= 2) return 1.25; // 125% faster
                return 1.0;                   // Base speed
            }

            spawnEnemy() {
                const types = ['scout', 'fighter', 'interceptor', 'tank', 'transport'];
                const type = types[Math.floor(Math.random() * types.length)];
                const x = this.width + 50; // Spawn from right side
                // Spawn enemies lower on screen - avoid top 80px to prevent enemies at very top
                const minY = 80; // Minimum Y position from top
                const maxY = this.height - 20; // Maximum Y position
                const y = minY + Math.random() * (maxY - minY); // Random vertical position between minY and maxY

                this.enemies.push(new Enemy(x, y, type, this.gameSpeed));
            }

            spawnPowerup() {
                const types = ['health', 'weapon', 'shield'];
                const type = types[Math.floor(Math.random() * types.length)];
                const x = this.width + 30; // Spawn from right side
                // Spawn powerups lower on screen - avoid top 80px (same as enemies)
                const minY = 80; // Minimum Y position from top
                const maxY = this.height - 20; // Maximum Y position
                const y = minY + Math.random() * (maxY - minY); // Random vertical position between minY and maxY

                this.powerups.push(new Powerup(x, y, type));
            }

            checkCollisions() {
                // Bullet vs Enemy (20% margin for enemies)
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        if (this.bullets[i].collidesWith(this.enemies[j], 0.2)) { // 20% margin
                            this.bullets.splice(i, 1);
                            this.enemies[j].takeDamage(25);

                            if (this.enemies[j].health <= 0) {
                                this.score += this.enemies[j].points;
                                this.enemiesKilled++;
                                this.totalEnemiesKilled++; // Track total for mid-roll ad
                                this.createExplosion(this.enemies[j].x, this.enemies[j].y);
                                this.playSFX('explosion');
                                this.enemies.splice(j, 1);

                                // Mid-roll interstitial removed
                            }
                            break;
                        }
                    }
                }

                // Player vs Enemy (40% margin for player)
                if (this.player) {
                    for (let i = this.enemies.length - 1; i >= 0; i--) {
                        if (this.player.collidesWith(this.enemies[i], 0.4)) { // 40% margin
                            this.health -= 20;
                            // FIXED: Kill count should only increase when enemy is actually shot/killed, not on collision
                            // Collision just damages player, doesn't count as a kill
                            this.createExplosion(this.enemies[i].x, this.enemies[i].y);
                            this.playSFX('explosion');
                            this.enemies.splice(i, 1);

                            if (this.health <= 0) {
                                this.playSFX('death');
                                this.gameOver();
                            }
                        }
                    }
                }

                // Player vs Powerup
                if (this.player) {
                    for (let i = this.powerups.length - 1; i >= 0; i--) {
                        if (this.player.collidesWith(this.powerups[i], 0.4)) {
                            this.powerups[i].apply(this);
                            this.powerups.splice(i, 1);
                        }
                    }
                }
            }

            createExplosion(x, y) {
                for (let i = 0; i < 8; i++) {
                    this.particles.push(new Particle(x, y));
                }
            }

            checkLevelCompletion() {
                console.log(`Level completion check: enemiesKilled=${this.enemiesKilled}, totalEnemiesInLevel=${this.totalEnemiesInLevel}, enemies.length=${this.enemies.length}`);
                
                // Level completes when we've killed/escaped enough enemies
                if (this.enemiesKilled >= this.totalEnemiesInLevel) {
                    console.log("Level completed! Showing midroll ad directly...");
                    // FIXED: Show midroll ad directly after clearing level, before popup
                    this.gameRunning = false; // Pause game
                    showAd();
                    console.log("Space Battle: Level Complete - Midroll ad shown directly");
                    
                    // Show popup after a short delay (ad will show first)
                    setTimeout(() => {
                        this.showLevelCompletePopup();
                    }, 500);
                }
            }

            showLevelCompletePopup() {
                console.log("showLevelCompletePopup called!");
                this.gameRunning = false;
                this.playSFX('levelUp');
                
                // Reset totalEnemiesKilled for next level
                this.totalEnemiesKilled = 0;
                
                // Check if in portrait mode - don't show popup
                const isPortrait = window.innerHeight > window.innerWidth;
                if (isPortrait) {
                    console.log("Portrait mode detected - skipping level complete popup");
                    // Show ad and proceed to next level after delay
                    setTimeout(() => {
                        this.startNextLevel();
                    }, 1000);
                    return;
                }
                
                // Create congratulations popup
                const popup = document.createElement('div');
                popup.id = 'levelCompletePopup';
                // Check if in fullscreen mode
                const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                     document.mozFullScreenElement || document.msFullscreenElement);
                const fullscreenElement = document.fullscreenElement || document.webkitFullscreenElement || 
                                         document.mozFullScreenElement || document.msFullscreenElement;
                
                popup.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 999999 !important;
                `;
                
                popup.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
                        padding: 1rem;
                        border-radius: 12px;
                        text-align: center;
                        color: #fff;
                        max-width: 320px;
                        width: 85%;
                        max-height: 60vh;
                        min-height: 200px;
                        overflow-y: auto;
                        border: 2px solid #00ff88;
                        box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between;
                    ">
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                            <h2 style="color: #00ff88; font-size: 1.1rem; margin-bottom: 0.5rem; text-shadow: 0 0 10px #00ff88;">
                                ðŸŽ‰ CONGRATULATIONS! ðŸŽ‰
                            </h2>
                            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                                Level ${this.level} Complete!
                            </p>
                            <p style="color: #ffaa00; margin-bottom: 0.5rem; font-size: 0.8rem;">
                                Enemies Defeated: ${this.enemiesKilled}/${this.totalEnemiesInLevel}
                            </p>
                            <p style="color: #00ccff; margin-bottom: 0.5rem; font-size: 0.8rem;">
                                Next Level: ${this.level + 1} (${this.calculateEnemiesForLevel(this.level + 1)} enemies)
                            </p>
                        </div>
                        <button onclick="game.startNextLevel()" style="
                            background: linear-gradient(45deg, #00ff88, #00ccff);
                            border: none;
                            color: #000;
                            padding: 10px 20px;
                            font-size: 0.9rem;
                            font-weight: bold;
                            border-radius: 6px;
                            cursor: pointer;
                            margin-top: 0.5rem;
                            transition: all 0.3s ease;
                            display: block;
                            width: 100%;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Start Level ${this.level + 1}
                        </button>
                    </div>
                `;
                
                // Attach popup to fullscreen element if in fullscreen, otherwise to body
                if (isFullscreen && fullscreenElement) {
                    fullscreenElement.appendChild(popup);
                    console.log("Popup attached to fullscreen element");
                } else {
                    document.body.appendChild(popup);
                    console.log("Popup attached to body");
                }
                
                // Force show popup with timeout
                setTimeout(() => {
                    popup.style.display = 'flex';
                    popup.style.visibility = 'visible';
                    popup.style.opacity = '1';
                    console.log("Popup forced to show");
                }, 100);
                
                console.log(`Space Battle: Level ${this.level} completed! Showing congratulations popup.`);
            }

            startNextLevel() {
                console.log("Starting next level...");
                
                // Remove popup
                const popup = document.getElementById('levelCompletePopup');
                if (popup) {
                    popup.remove();
                }
                
                // FIXED: Midroll ad already shown directly after level completion
                // No need to show again here - just start next level
                // Ads are cached in start() method for next level
                
                // Start next level (will cache ads in start method)
                this.levelUp();
                this.start();
                console.log(`Started Level ${this.level} with ${this.totalEnemiesInLevel} enemies`);
            }

            returnToMenu() {
                console.log("Returning to menu...");
                
                // Remove all popups (level complete and game over)
                const levelCompletePopup = document.getElementById('levelCompletePopup');
                if (levelCompletePopup) {
                    levelCompletePopup.remove();
                }
                
                const gameOverPopup = document.getElementById('gameOverPopup');
                if (gameOverPopup) {
                    gameOverPopup.remove();
                }
                
                // Stop game
                this.gameRunning = false;
                
                // Save statistics when returning to menu
                this.saveStatistics(true); // Game is ending
                
                // Hide game section
                const gameSection = document.getElementById('gameSection');
                if (gameSection) {
                    gameSection.classList.remove('active');
                    gameSection.style.display = 'none';
                }
                
                // Show menu overlay
                const menuOverlay = document.getElementById('menuOverlay');
                if (menuOverlay) {
                    menuOverlay.style.display = 'flex';
                }
                
                // Show main menu
                MenuUI.showMainMenu();
                console.log("Returned to main menu successfully");
            }

            levelUp() {
                this.level++;
                this.enemiesKilled = 0;
                this.totalEnemiesKilled = 0; // Reset for new level
                this.totalEnemiesInLevel = this.calculateEnemiesForLevel(this.level);
                this.gameSpeed = this.calculateSpeedMultiplier(this.level);

                console.log(`Space Battle: Level ${this.level} started!`);
                console.log(`Enemies: ${this.totalEnemiesInLevel}, Speed: ${this.gameSpeed}x`);

                // Update best level
                const bestLevel = parseInt(localStorage.getItem('bestLevel') || '0');
                if (this.level > bestLevel) {
                    localStorage.setItem('bestLevel', this.level.toString());
                }
            }

            updateUI() {
                document.getElementById('score').textContent = `Score: ${this.score}`;
                document.getElementById('level').textContent = `Level: ${this.level}`;
                document.getElementById('healthFill').style.width = `${this.health}%`;
                document.getElementById('enemiesLeft').textContent = `Progress: ${this.enemiesKilled}/${this.totalEnemiesInLevel} (${Math.round((this.enemiesKilled/this.totalEnemiesInLevel)*100)}%)`;
            }

            pauseGame() {
                this.gameRunning = false;
                
                // Save statistics when pausing
                this.saveStatistics(false); // Game is not ending, just pausing
                
                MenuUI.showMainMenu();
            }

            saveStatistics(isGameEnd = false) {
                console.log("=== SAVING STATISTICS ===");
                console.log(`Current game stats - Score: ${this.score}, Level: ${this.level}, Enemies Killed: ${this.enemiesKilled}`);
                console.log(`Is game end: ${isGameEnd}`);
                
                // Get current localStorage values
                const currentHighScore = parseInt(localStorage.getItem('highScore') || '0');
                const currentGamesPlayed = parseInt(localStorage.getItem('gamesPlayed') || '0');
                const currentTotalEnemies = parseInt(localStorage.getItem('totalEnemiesKilled') || '0');
                const currentBestLevel = parseInt(localStorage.getItem('bestLevel') || '0');
                
                console.log(`Current localStorage values - High Score: ${currentHighScore}, Games Played: ${currentGamesPlayed}, Total Enemies: ${currentTotalEnemies}, Best Level: ${currentBestLevel}`);
                
                // Only increment gamesPlayed if this is actually the end of a game
                const gamesPlayedIncrement = isGameEnd ? 1 : 0;
                
                // Save statistics
                const stats = {
                    highScore: Math.max(currentHighScore, this.score),
                    gamesPlayed: currentGamesPlayed + gamesPlayedIncrement,
                    totalEnemiesKilled: currentTotalEnemies + this.enemiesKilled,
                    bestLevel: Math.max(currentBestLevel, this.level)
                };

                console.log(`New statistics to save:`, stats);

                localStorage.setItem('highScore', stats.highScore.toString());
                localStorage.setItem('gamesPlayed', stats.gamesPlayed.toString());
                localStorage.setItem('totalEnemiesKilled', stats.totalEnemiesKilled.toString());
                localStorage.setItem('bestLevel', stats.bestLevel.toString());
                
                // Verify what was actually saved
                console.log(`Verification - localStorage now contains:`);
                console.log(`High Score: ${localStorage.getItem('highScore')}`);
                console.log(`Games Played: ${localStorage.getItem('gamesPlayed')}`);
                console.log(`Total Enemies: ${localStorage.getItem('totalEnemiesKilled')}`);
                console.log(`Best Level: ${localStorage.getItem('bestLevel')}`);
                console.log("=== END SAVING STATISTICS ===");
                
                return stats;
            }

            gameOver() {
                this.gameRunning = false;
                this.playSFX('death');

                // Save statistics
                this.saveStatistics(true); // Game is ending

                // FIXED: Show rewarded popup BEFORE game over screen
                // Check if rewarded ad is ready
                if (window.isRVReady === true) {
                    console.log("Space Battle: Game Over - Showing rewarded popup before game over screen");
                    this.showRewardedPopup();
                } else {
                    // If rewarded ad not ready, show midroll ad and then game over
                    showAd();
                    console.log("Space Battle: Game Over - Mid-roll ad call made (rewarded not ready)");
                    
                    // Show Game Over modal after ad
                    setTimeout(() => {
                        this.showGameOverModal();
                    }, 500);
                }
            }
            
            showRewardedPopup() {
                console.log("Showing rewarded popup before game over...");
                
                // Create rewarded popup
                const popup = document.createElement('div');
                popup.id = 'rewardedPopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 999999 !important;
                `;
                
                popup.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
                        padding: 1.5rem;
                        border-radius: 15px;
                        text-align: center;
                        color: #fff;
                        max-width: 300px;
                        width: 80%;
                        border: 2px solid #ffaa00;
                        box-shadow: 0 0 30px rgba(255, 170, 0, 0.5);
                    ">
                        <h2 style="color: #ffaa00; font-size: 1.2rem; margin-bottom: 1rem;">
                            Continue Playing?
                        </h2>
                        <p style="font-size: 0.9rem; margin-bottom: 1rem;">
                            Watch a video to continue with extra health!
                        </p>
                        <button onclick="game.acceptRewarded()" style="
                            background: linear-gradient(45deg, #ffaa00, #ff8800);
                            border: none;
                            color: #000;
                            padding: 10px 20px;
                            font-size: 0.9rem;
                            font-weight: bold;
                            border-radius: 8px;
                            cursor: pointer;
                            margin: 0.3rem;
                            transition: all 0.3s ease;
                            display: block;
                            width: 100%;
                        ">
                            ðŸŽ¬ Yes, Watch Ad
                        </button>
                        <button onclick="game.declineRewarded()" style="
                            background: linear-gradient(45deg, #6c757d, #495057);
                            border: none;
                            color: #fff;
                            padding: 10px 20px;
                            font-size: 0.9rem;
                            font-weight: bold;
                            border-radius: 8px;
                            cursor: pointer;
                            margin: 0.3rem;
                            transition: all 0.3s ease;
                            display: block;
                            width: 100%;
                        ">
                            âŒ No, Continue to Game Over
                        </button>
                    </div>
                `;
                
                document.body.appendChild(popup);
                console.log("Rewarded popup displayed");
            }
            
            acceptRewarded() {
                console.log("User accepted rewarded ad");
                const popup = document.getElementById('rewardedPopup');
                if (popup) {
                    popup.remove();
                }
                // FIXED: Show rewarded ad - game will resume automatically after reward via grantRewardExtraHealth
                showAdRewarded();
                console.log("Space Battle: Rewarded ad shown - game will resume after reward");
            }
            
            declineRewarded() {
                console.log("User declined rewarded ad");
                const popup = document.getElementById('rewardedPopup');
                if (popup) {
                    popup.remove();
                }
                // Show midroll ad and then game over
                showAd();
                setTimeout(() => {
                    this.showGameOverModal();
                }, 500);
            }

            showGameOverModal() {
                console.log("Showing Game Over modal");
                
                // Remove any existing popup
                const existingPopup = document.getElementById('gameOverPopup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // Note: Rewarded ad is already cached on game start/restart via gameCacheAd()
                // No need to cache again here - will be cached automatically via onAdClosed() after any ad
                
                // Post score
                const finalScore = Math.floor(this.score);
                postScore(finalScore);
                
                // Check if in fullscreen mode
                const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                     document.mozFullScreenElement || document.msFullscreenElement);
                const fullscreenElement = document.fullscreenElement || document.webkitFullscreenElement || 
                                         document.mozFullScreenElement || document.msFullscreenElement;
                
                // Create Game Over popup
                const popup = document.createElement('div');
                popup.id = 'gameOverPopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 999999 !important;
                `;
                
                // FIXED: Remove RV video button from Game Over screen
                // Rewarded option is now handled via a separate popup before Game Over
                const continueButtonHtml = '';
                
                popup.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
                        padding: 1rem;
                        border-radius: 15px;
                        text-align: center;
                        color: #fff;
                        max-width: 300px;
                        width: 80%;
                        border: 2px solid #ff0000;
                        box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
                    ">
                        <h2 style="color: #ff0000; font-size: 1.2rem; margin-bottom: 0.5rem; text-shadow: 0 0 10px #ff0000;">
                            ðŸ’€ GAME OVER ðŸ’€
                        </h2>
                        <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Your ship has been destroyed!
                        </p>
                        <p style="color: #ffaa00; margin-bottom: 0.5rem; font-size: 0.8rem;">
                            Final Score: ${this.score}
                        </p>
                        <p style="color: #00ccff; margin-bottom: 0.5rem; font-size: 0.8rem;">
                            Level Reached: ${this.level}
                        </p>
                        <p style="color: #00ff88; margin-bottom: 1rem; font-size: 0.8rem;">
                            Enemies Defeated: ${this.enemiesKilled}
                        </p>
                        ${continueButtonHtml}
                        <button onclick="game.restartGameWithAd()" style="
                            background: linear-gradient(45deg, #00ff88, #00ccff);
                            border: none;
                            color: #000;
                            padding: 10px 20px;
                            font-size: 0.9rem;
                            font-weight: bold;
                            border-radius: 8px;
                            cursor: pointer;
                            margin: 0.3rem;
                            transition: all 0.3s ease;
                            display: block;
                            width: 100%;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            ðŸ”„ Restart Game
                        </button>
                        <button onclick="game.returnToMenu()" style="
                            background: linear-gradient(45deg, #6c757d, #495057);
                            border: none;
                            color: #fff;
                            padding: 10px 20px;
                            font-size: 0.9rem;
                            font-weight: bold;
                            border-radius: 8px;
                            cursor: pointer;
                            margin: 0.3rem;
                            transition: all 0.3s ease;
                            display: block;
                            width: 100%;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            ðŸ  Home / Main Menu
                        </button>
                    </div>
                `;
                
                // Attach popup to fullscreen element if in fullscreen, otherwise to body
                if (isFullscreen && fullscreenElement) {
                    fullscreenElement.appendChild(popup);
                    console.log("Game Over popup attached to fullscreen element");
                } else {
                    document.body.appendChild(popup);
                    console.log("Game Over popup attached to body");
                }
                
                // Force show popup with timeout
                setTimeout(() => {
                    popup.style.display = 'flex';
                    popup.style.visibility = 'visible';
                    popup.style.opacity = '1';
                    console.log("Game Over popup forced to show");
                    
                    // Wait for rewarded ad to be ready and update continue button
                    if (!window.isRVReady) {
                        console.log("Space Battle: Rewarded ad not ready, waiting for ad to load...");
                        var checkCount = 0;
                        var maxChecks = 60; // 30 seconds max wait
                        var adReadyShown = false;
                        
                        var checkAdReady = setInterval(function() {
                            checkCount++;
                            console.log("Space Battle: Checking rewarded ad ready status...", window.isRVReady, "Check:", checkCount);
                            
                            if (window.isRVReady === true) {
                                clearInterval(checkAdReady);
                                if (!adReadyShown) {
                                    adReadyShown = true;
                                    // Update popup to show continue button
                                    const continueBtn = popup.querySelector('button[onclick*="continueWithRewarded"]');
                                    if (!continueBtn) {
                                        const restartBtn = popup.querySelector('button[onclick*="restartGameWithAd"]');
                                        if (restartBtn && restartBtn.parentElement) {
                                            const continueButton = document.createElement('button');
                                            continueButton.onclick = function() { 
                                                if (window.game && window.game.continueWithRewarded) {
                                                    window.game.continueWithRewarded(); 
                                                }
                                            };
                                            continueButton.innerHTML = 'ðŸŽ¬ Watch Ad to Continue';
                                            continueButton.style.cssText = `
                                                background: linear-gradient(45deg, #ffaa00, #ff8800);
                                                border: none;
                                                color: #000;
                                                padding: 10px 20px;
                                                font-size: 0.9rem;
                                                font-weight: bold;
                                                border-radius: 8px;
                                                cursor: pointer;
                                                margin: 0.3rem;
                                                transition: all 0.3s ease;
                                                display: block;
                                                width: 100%;
                                            `;
                                            restartBtn.parentElement.insertBefore(continueButton, restartBtn);
                                            console.log("Space Battle: Continue button added to popup");
                                        }
                                    }
                                    console.log("Space Battle: Rewarded ad ready - continue button shown");
                                }
                            } else if (checkCount >= maxChecks) {
                                clearInterval(checkAdReady);
                                console.log("Space Battle: Rewarded ad failed to load after 30 seconds");
                            }
                        }, 500);
                    } else {
                        console.log("Space Battle: Rewarded ad already ready, continue button should be visible");
                    }
                }, 100);
                
                console.log("Game Over modal displayed");
            }

            continueWithRewarded() {
                console.log("Continue with rewarded ad...");
                
                // Remove popup
                const popup = document.getElementById('gameOverPopup');
                if (popup) {
                    popup.remove();
                }
                
                // Remove rewarded popup if exists
                const rewardedPopup = document.getElementById('rewardedPopup');
                if (rewardedPopup) {
                    rewardedPopup.remove();
                }
                
                // FIXED: Show rewarded ad - ensure game doesn't get stuck after ad closes
                showAdRewarded();
                console.log("Space Battle: Rewarded ad call made for continue");
                
                // Note: Reward will be granted via GratifyReward() in onAdClosed callback
                // Game will resume automatically via grantRewardExtraHealth()
            }

            restartGameWithAd() {
                console.log("Restarting game with ad...");
                
                // Remove popup
                const popup = document.getElementById('gameOverPopup');
                if (popup) {
                    popup.remove();
                }
                
                // Note: gameCacheAd() will be called in restartGame() - no duplicate call here
                
                // Restart game (will cache ads in restartGame)
                this.restartGame();
            }

            restartGame() {
                console.log("Restarting game...");
                
                // Remove popup
                const popup = document.getElementById('gameOverPopup');
                if (popup) {
                    popup.remove();
                }
                
                // Cache ads for new game
                gameCacheAd();
                console.log("Space Battle: Restart Game - Ads caching started");
                
                // Reset game state
                this.score = 0;
                this.level = 1;
                this.health = 100;
                this.enemiesKilled = 0;
                this.totalEnemiesInLevel = this.calculateEnemiesForLevel(this.level);
                this.gameSpeed = this.calculateSpeedMultiplier(this.level);
                
                // Clear arrays
                this.bullets = [];
                this.enemies = [];
                this.particles = [];
                this.powerups = [];
                
                // Update UI immediately to show reset values
                this.updateUI();
                
                // Start new game
                this.start();
                console.log("Game restarted successfully");
            }

            render() {
                // Clear canvas
                this.ctx.fillStyle = '#000011';
                this.ctx.fillRect(0, 0, this.width, this.height);

                // Draw stars background
                this.drawStars();

                // Draw game objects (player first, then enemies for proper layering)
                if (this.player) this.player.render(this.ctx);

                // Draw enemies
                this.enemies.forEach(enemy => enemy.render(this.ctx));

                // Draw other objects
                this.bullets.forEach(bullet => bullet.render(this.ctx));
                this.powerups.forEach(powerup => powerup.render(this.ctx));
                this.particles.forEach(particle => particle.render(this.ctx));
            }

            drawStars() {
                // Create stable star field without blinking
                for (let i = 0; i < 120; i++) {
                    // Fixed star sizes for consistent appearance
                    const starSize = (i % 3) + 1; // 1, 2, or 3 pixels
                    const starSpeed = (starSize / 3) * this.gameSpeed;

                    // Moving star positions (scrolling right to left)
                    const baseX = (i * 37) % this.width;
                    const baseY = (i * 23) % this.height;

                    // Apply smooth horizontal movement (right to left)
                    const moveX = (this.lastTime * 0.02 * starSpeed) % this.width;
                    const x = (baseX - moveX + this.width) % this.width;
                    const y = baseY;

                    // Fixed star colors based on size (no random brightness)
                    if (starSize === 1) {
                        // Small dim stars
                        this.ctx.fillStyle = 'rgba(180, 200, 255, 0.6)';
                    } else if (starSize === 2) {
                        // Medium stars
                        this.ctx.fillStyle = 'rgba(220, 240, 255, 0.8)';
                    } else {
                        // Large bright stars
                        this.ctx.fillStyle = 'rgba(255, 255, 255, 1.0)';
                    }

                    // Draw star
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, starSize, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // Add some larger distant stars (moving right to left)
                for (let i = 0; i < 25; i++) {
                    const baseX = (i * 73) % this.width;
                    const baseY = (i * 41) % this.height;
                    
                    // Apply smooth horizontal movement (right to left)
                    const moveX = (this.lastTime * 0.01) % this.width;
                    const x = (baseX - moveX + this.width) % this.width;
                    const y = baseY;

                    // Fixed distant star sizes
                    const distantStarSize = (i % 2) + 2; // 2 or 3 pixels
                    const brightness = 0.7; // Fixed brightness

                    // Distant blue stars with fixed brightness
                    if (distantStarSize === 2) {
                        this.ctx.fillStyle = `rgba(150, 200, 255, ${brightness})`;
                    } else {
                        this.ctx.fillStyle = `rgba(180, 220, 255, ${brightness})`;
                    }

                    this.ctx.beginPath();
                    this.ctx.arc(x, y, distantStarSize, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
        }

        // Player class - Rocket Ship
        class Player {
            constructor(x, y, canvasHeight) {
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 60;
                this.speed = 5;
                this.shooting = false;
                this.shootCooldown = 0;
                this.steamParticles = [];
                this.canvasHeight = canvasHeight || 500; // Store canvas height for movement bounds
            }

            update(mouseX, mouseY, mousePressed, deltaTime) {
                // Keep player fixed on left side, only vertical movement allowed
                this.x = 50; // Fixed position on left side
                
                // Move towards mouse (only vertical movement, no horizontal)
                const dy = mouseY - this.y;
                const distance = Math.abs(dy);

                // Only move if mouseY is valid (not 0 or undefined)
                if (distance > 5 && mouseY > 0 && mouseY < this.canvasHeight) {
                    this.y += (dy / distance) * this.speed;
                }

                // Constrain vertical movement
                this.y = Math.max(50, Math.min(this.y, this.canvasHeight - 50)); // Allow full vertical movement

                // Shooting
                this.shootCooldown -= deltaTime;
                this.shooting = mousePressed && this.shootCooldown <= 0;

                if (this.shooting) {
                    this.shootCooldown = 200; // 200ms cooldown
                }

                // Update steam particles
                this.steamParticles = this.steamParticles.filter(particle => {
                    particle.update(deltaTime);
                    return particle.life > 0;
                });

                // Add new steam particles (from back of rocket - both engine nozzles)
                if (Math.random() < 0.3) {
                    // Randomly choose which engine nozzle to emit from
                    const engineIndex = Math.random() < 0.5 ? 0 : 1;
                    const engineY = this.y + (engineIndex === 0 ? 12 : 18); // Top engine or bottom engine
                    this.steamParticles.push(new SteamParticle(this.x, engineY));
                }
            }

            collidesWith(obj, margin = 0.4) {
                const effectiveWidth = this.width * (1 - margin);
                const effectiveHeight = this.height * (1 - margin);
                const offsetX = (this.width - effectiveWidth) / 2;
                const offsetY = (this.height - effectiveHeight) / 2;

                return this.x + offsetX < obj.x + obj.width &&
                       this.x + this.width - offsetX > obj.x &&
                       this.y + offsetY < obj.y + obj.height &&
                       this.y + this.height - offsetY > obj.y;
            }

            render(ctx) {
                // Draw classic rocket ship ðŸš€ (facing right)
                
                // Main rocket body - sleek silver/white
                const bodyGradient = ctx.createLinearGradient(this.x, this.y + 15, this.x + 40, this.y + 15);
                bodyGradient.addColorStop(0, '#e0e0e0');
                bodyGradient.addColorStop(0.3, '#ffffff');
                bodyGradient.addColorStop(0.7, '#f0f0f0');
                bodyGradient.addColorStop(1, '#d0d0d0');
                ctx.fillStyle = bodyGradient;
                ctx.fillRect(this.x + 5, this.y + 8, 35, 14);

                // Sharp nose cone (facing right) - iconic rocket tip
                const noseGradient = ctx.createLinearGradient(this.x + 40, this.y + 15, this.x + 55, this.y + 15);
                noseGradient.addColorStop(0, '#ffffff');
                noseGradient.addColorStop(1, '#ff6666');
                ctx.fillStyle = noseGradient;
                ctx.beginPath();
                ctx.moveTo(this.x + 55, this.y + 15);
                ctx.lineTo(this.x + 40, this.y + 5);
                ctx.lineTo(this.x + 40, this.y + 25);
                ctx.closePath();
                ctx.fill();

                // Classic rocket fins - red triangular fins
                ctx.fillStyle = '#ff3333';
                ctx.beginPath();
                ctx.moveTo(this.x + 5, this.y + 8);
                ctx.lineTo(this.x + 5, this.y);
                ctx.lineTo(this.x + 15, this.y + 8);
                ctx.closePath();
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(this.x + 5, this.y + 22);
                ctx.lineTo(this.x + 5, this.y + 30);
                ctx.lineTo(this.x + 15, this.y + 22);
                ctx.closePath();
                ctx.fill();

                // Cockpit window - blue circular window
                ctx.fillStyle = '#4444ff';
                ctx.beginPath();
                ctx.arc(this.x + 35, this.y + 15, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#aaddff';
                ctx.beginPath();
                ctx.arc(this.x + 35, this.y + 15, 3, 0, Math.PI * 2);
                ctx.fill();

                // Window glow
                ctx.shadowColor = '#4444ff';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(this.x + 35, this.y + 15, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Rocket stripes - classic red stripe
                ctx.fillStyle = '#ff3333';
                ctx.fillRect(this.x + 20, this.y + 10, 15, 3);
                ctx.fillRect(this.x + 20, this.y + 17, 15, 3);

                // Engine nozzles
                ctx.fillStyle = '#333333';
                ctx.fillRect(this.x, this.y + 10, 8, 4);
                ctx.fillRect(this.x, this.y + 16, 8, 4);

                // Powerful engine flames - orange/yellow/red gradient
                const flameGradient = ctx.createLinearGradient(this.x - 20, this.y + 15, this.x, this.y + 15);
                flameGradient.addColorStop(0, '#ffff00');
                flameGradient.addColorStop(0.3, '#ffaa00');
                flameGradient.addColorStop(0.6, '#ff6600');
                flameGradient.addColorStop(1, '#ff0000');
                ctx.fillStyle = flameGradient;
                
                // Animated flame effect
                const flameOffset = Math.sin(Date.now() * 0.01) * 3;
                ctx.fillRect(this.x - 20, this.y + 10, 20 + flameOffset, 4);
                ctx.fillRect(this.x - 20, this.y + 16, 20 + flameOffset, 4);

                // Bright flame core
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(this.x - 5, this.y + 11, 5, 2);
                ctx.fillRect(this.x - 5, this.y + 17, 5, 2);

                // Draw steam particles
                this.steamParticles.forEach(particle => particle.render(ctx));
            }
        }

        // Steam Particle class
        class SteamParticle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                // Move left (backward) since rocket moves right (forward)
                this.vx = -(Math.random() * 2 + 1); // Negative velocity to move left
                this.vy = (Math.random() - 0.5) * 1; // Small vertical variation
                this.life = 30;
                this.maxLife = 30;
                this.size = Math.random() * 3 + 1;
            }

            update(deltaTime) {
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
                this.size *= 0.98;
            }

            render(ctx) {
                const alpha = this.life / this.maxLife;
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.8})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Bullet class - Horizontal Projectiles
        class Bullet {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 15;  // Horizontal width
                this.height = 6;  // Vertical height
                this.speed = 8;
                this.trail = [];
            }

            update(deltaTime) {
                this.x += this.speed; // Move right instead of up

                // Add trail particles (from back of projectile)
                this.trail.push({
                    x: this.x - 5,
                    y: this.y + this.height/2,
                    life: 10
                });

                // Update trail
                this.trail = this.trail.filter(particle => {
                    particle.life--;
                    return particle.life > 0;
                });
            }

            collidesWith(obj, margin = 0.2) {
                const effectiveWidth = this.width * (1 - margin);
                const effectiveHeight = this.height * (1 - margin);
                const offsetX = (this.width - effectiveWidth) / 2;
                const offsetY = (this.height - effectiveHeight) / 2;

                return this.x + offsetX < obj.x + obj.width &&
                       this.x + this.width - offsetX > obj.x &&
                       this.y + offsetY < obj.y + obj.height &&
                       this.y + this.height - offsetY > obj.y;
            }

            render(ctx) {
                // Draw horizontal rocket projectile with metallic look
                const gradient = ctx.createLinearGradient(this.x, this.y, this.x + this.width, this.y);
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(0.3, '#c0c0c0');
                gradient.addColorStop(0.7, '#808080');
                gradient.addColorStop(1, '#404040');

                ctx.fillStyle = gradient;
                ctx.fillRect(this.x, this.y, this.width, this.height);

                // Draw projectile nose (pointing right)
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.moveTo(this.x + this.width, this.y + 3);
                ctx.lineTo(this.x + this.width - 5, this.y);
                ctx.lineTo(this.x + this.width - 5, this.y + this.height);
                ctx.closePath();
                ctx.fill();

                // Draw rocket body (horizontal)
                ctx.fillStyle = '#c0c0c0';
                ctx.fillRect(this.x + 5, this.y + 1, this.width - 10, this.height - 2);

                // Draw rocket fins (vertical fins for horizontal projectile)
                ctx.fillStyle = '#606060';
                ctx.fillRect(this.x + 2, this.y, 2, this.height);
                ctx.fillRect(this.x + this.width - 4, this.y, 2, this.height);

                // Draw engine flame (at back - left side)
                const flameGradient = ctx.createLinearGradient(this.x - 8, this.y, this.x, this.y);
                flameGradient.addColorStop(0, '#ffaa00');
                flameGradient.addColorStop(0.5, '#ff6600');
                flameGradient.addColorStop(1, '#ff0000');
                ctx.fillStyle = flameGradient;
                ctx.fillRect(this.x - 8, this.y + 1, 8, this.height - 2);

                // Draw trail particles
                this.trail.forEach(particle => {
                    const alpha = particle.life / 10;
                    ctx.fillStyle = `rgba(255, 200, 0, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
        }

        // Enemy class - Enemy Ships
        class Enemy {
            constructor(x, y, type, speedMultiplier = 1) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 50;
                this.height = 50;
                this.baseSpeed = 2;
                this.speed = this.baseSpeed * speedMultiplier;
                this.health = 50;
                this.points = 100;
                this.animationFrame = 0;

                // Set properties based on type
                switch (type) {
                    case 'scout':
                        this.baseSpeed = 3;
                        this.health = 30;
                        this.points = 50;
                        this.color = '#00ff00';
                        this.enemyType = 'scout';
                        break;
                    case 'fighter':
                        this.baseSpeed = 2;
                        this.health = 60;
                        this.points = 100;
                        this.color = '#ff0000';
                        this.enemyType = 'fighter';
                        break;
                    case 'interceptor':
                        this.baseSpeed = 4;
                        this.health = 40;
                        this.points = 150;
                        this.color = '#0000ff';
                        this.enemyType = 'interceptor';
                        break;
                    case 'tank':
                        this.baseSpeed = 1;
                        this.health = 100;
                        this.points = 200;
                        this.color = '#ffaa00';
                        this.enemyType = 'tank';
                        break;
                    case 'transport':
                        this.baseSpeed = 1.5;
                        this.health = 80;
                        this.points = 300;
                        this.color = '#ff00ff';
                        this.enemyType = 'transport';
                        break;
                }

                this.speed = this.baseSpeed * speedMultiplier;
            }

            update(deltaTime) {
                this.x -= this.speed; // Move left instead of down
                this.animationFrame += 0.1;
            }

            takeDamage(damage) {
                this.health -= damage;
            }

            render(ctx) {
                // Draw enemy ship based on type
                switch (this.enemyType) {
                    case 'scout':
                        this.drawScoutShip(ctx);
                        break;
                    case 'fighter':
                        this.drawFighterShip(ctx);
                        break;
                    case 'interceptor':
                        this.drawInterceptorShip(ctx);
                        break;
                    case 'tank':
                        this.drawTankShip(ctx);
                        break;
                    case 'transport':
                        this.drawTransportShip(ctx);
                        break;
                }
            }

            drawScoutShip(ctx) {
                // Alien scout ship with organic look (facing left)
                const bodyGradient = ctx.createLinearGradient(this.x, this.y + 5, this.x + 30, this.y + 25);
                bodyGradient.addColorStop(0, '#00ff00');
                bodyGradient.addColorStop(0.5, '#00cc00');
                bodyGradient.addColorStop(1, '#008800');
                ctx.fillStyle = bodyGradient;
                ctx.fillRect(this.x, this.y + 5, 30, 20);

                // Alien ship nose with glowing tip (facing left)
                ctx.fillStyle = '#004400';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y + 15);
                ctx.lineTo(this.x + 15, this.y + 5);
                ctx.lineTo(this.x + 15, this.y + 25);
                ctx.closePath();
                ctx.fill();

                // Glowing nose tip
                ctx.fillStyle = '#88ff88';
                ctx.beginPath();
                ctx.arc(this.x + 3, this.y + 15, 2, 0, Math.PI * 2);
                ctx.fill();

                // Alien wings with organic curves
                ctx.fillStyle = '#006600';
                ctx.fillRect(this.x + 5, this.y, 8, 10);
                ctx.fillRect(this.x + 5, this.y + 20, 8, 10);

                // Alien eyes/weapons
                ctx.fillStyle = '#ff0000';
                ctx.beginPath();
                ctx.arc(this.x + 12, this.y + 8, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(this.x + 12, this.y + 22, 2, 0, Math.PI * 2);
                ctx.fill();

                // Alien energy core
                ctx.fillStyle = '#00ffff';
                ctx.beginPath();
                ctx.arc(this.x + 8, this.y + 15, 3, 0, Math.PI * 2);
                ctx.fill();
            }

            drawFighterShip(ctx) {
                // Alien fighter with menacing look (facing left)
                const bodyGradient = ctx.createLinearGradient(this.x, this.y + 5, this.x + 35, this.y + 30);
                bodyGradient.addColorStop(0, '#ff0000');
                bodyGradient.addColorStop(0.5, '#cc0000');
                bodyGradient.addColorStop(1, '#880000');
                ctx.fillStyle = bodyGradient;
                ctx.fillRect(this.x, this.y + 5, 35, 25);

                // Alien ship nose with spikes (facing left)
                ctx.fillStyle = '#aa0000';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y + 17);
                ctx.lineTo(this.x + 15, this.y + 5);
                ctx.lineTo(this.x + 15, this.y + 30);
                ctx.closePath();
                ctx.fill();

                // Spiked nose
                ctx.fillStyle = '#ff6666';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y + 17);
                ctx.lineTo(this.x + 3, this.y + 14);
                ctx.lineTo(this.x + 3, this.y + 20);
                ctx.closePath();
                ctx.fill();

                // Alien wings with weapons
                ctx.fillStyle = '#cc0000';
                ctx.fillRect(this.x + 5, this.y, 12, 15);
                ctx.fillRect(this.x + 5, this.y + 20, 12, 15);

                // Wing weapons
                ctx.fillStyle = '#ffaa00';
                ctx.fillRect(this.x + 8, this.y + 2, 6, 4);
                ctx.fillRect(this.x + 8, this.y + 24, 6, 4);

                // Alien cockpit with glow
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(this.x + 12, this.y + 10, 8, 6);
                ctx.shadowColor = '#ffff00';
                ctx.shadowBlur = 5;
                ctx.fillRect(this.x + 12, this.y + 10, 8, 6);
                ctx.shadowBlur = 0;

                // Alien energy core
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(this.x + 8, this.y + 18, 12, 4);
            }

            drawInterceptorShip(ctx) {
                // Fast alien interceptor with sleek design (facing left)
                const bodyGradient = ctx.createLinearGradient(this.x, this.y + 15, this.x + 30, this.y + 15);
                bodyGradient.addColorStop(0, '#0000ff');
                bodyGradient.addColorStop(0.5, '#4444ff');
                bodyGradient.addColorStop(1, '#8888ff');
                ctx.fillStyle = bodyGradient;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y + 15);
                ctx.lineTo(this.x + 30, this.y);
                ctx.lineTo(this.x + 30, this.y + 30);
                ctx.closePath();
                ctx.fill();

                // Ship body with energy core
                ctx.fillStyle = '#4444ff';
                ctx.fillRect(this.x + 5, this.y + 10, 20, 15);

                // Energy core glow
                ctx.fillStyle = '#00ffff';
                ctx.beginPath();
                ctx.arc(this.x + 8, this.y + 17, 4, 0, Math.PI * 2);
                ctx.fill();

                // Sleek wings
                ctx.fillStyle = '#6666ff';
                ctx.fillRect(this.x + 5, this.y + 5, 10, 8);
                ctx.fillRect(this.x + 5, this.y + 22, 10, 8);

                // Wing tips with weapons
                ctx.fillStyle = '#ff00ff';
                ctx.fillRect(this.x + 2, this.y + 7, 3, 4);
                ctx.fillRect(this.x + 2, this.y + 24, 3, 4);

                // Alien cockpit
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(this.x + 12, this.y + 12, 6, 6);
                ctx.shadowColor = '#ffffff';
                ctx.shadowBlur = 8;
                ctx.fillRect(this.x + 12, this.y + 12, 6, 6);
                ctx.shadowBlur = 0;
            }

            drawTankShip(ctx) {
                // Heavy alien tank with massive weapons (facing left)
                const bodyGradient = ctx.createLinearGradient(this.x, this.y, this.x + 40, this.y + 35);
                bodyGradient.addColorStop(0, '#ffaa00');
                bodyGradient.addColorStop(0.5, '#cc8800');
                bodyGradient.addColorStop(1, '#aa6600');
                ctx.fillStyle = bodyGradient;
                ctx.fillRect(this.x, this.y, 40, 35);

                // Heavy armor plating
                ctx.fillStyle = '#aa6600';
                ctx.fillRect(this.x + 5, this.y + 10, 30, 20);

                // Multiple weapon turrets
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(this.x + 8, this.y + 5, 8, 8);
                ctx.fillRect(this.x + 8, this.y + 22, 8, 8);
                ctx.fillRect(this.x + 15, this.y + 12, 10, 6);

                // Weapon barrels
                ctx.fillStyle = '#880000';
                ctx.fillRect(this.x + 2, this.y + 7, 6, 4);
                ctx.fillRect(this.x + 2, this.y + 24, 6, 4);
                ctx.fillRect(this.x + 5, this.y + 14, 8, 4);

                // Energy core
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(this.x + 8, this.y + 17, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            drawTransportShip(ctx) {
                // Massive alien transport with cargo bays (facing left)
                const bodyGradient = ctx.createLinearGradient(this.x, this.y, this.x + 45, this.y + 40);
                bodyGradient.addColorStop(0, '#ff00ff');
                bodyGradient.addColorStop(0.5, '#cc00cc');
                bodyGradient.addColorStop(1, '#aa00aa');
                ctx.fillStyle = bodyGradient;
                ctx.fillRect(this.x, this.y, 45, 40);

                // Command section (facing left)
                ctx.fillStyle = '#aa00aa';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y + 20);
                ctx.lineTo(this.x + 15, this.y + 5);
                ctx.lineTo(this.x + 15, this.y + 35);
                ctx.closePath();
                ctx.fill();

                // Main body with cargo bays
                ctx.fillStyle = '#cc00cc';
                ctx.fillRect(this.x + 5, this.y + 10, 35, 30);

                // Cargo bay doors
                ctx.fillStyle = '#880088';
                ctx.fillRect(this.x + 8, this.y + 15, 8, 20);
                ctx.fillRect(this.x + 25, this.y + 15, 8, 20);

                // Navigation lights
                ctx.fillStyle = '#00ffff';
                ctx.fillRect(this.x + 12, this.y + 5, 6, 6);
                ctx.fillRect(this.x + 12, this.y + 29, 6, 6);

                // Engine array
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(this.x + 20, this.y + 15, 15, 4);
                ctx.fillRect(this.x + 15, this.y + 25, 20, 4);

                // Central energy core
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(this.x + 8, this.y + 20, 6, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Powerup class
        class Powerup {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 30;
                this.speed = 2;
                this.type = type;

                switch (type) {
                    case 'health':
                        this.color = '#00ff00';
                        break;
                    case 'weapon':
                        this.color = '#ff0000';
                        break;
                    case 'shield':
                        this.color = '#0000ff';
                        break;
                }
            }

            update(deltaTime) {
                this.x -= this.speed; // Move left (right to left)
            }

            apply(game) {
                switch (this.type) {
                    case 'health':
                        game.health = Math.min(100, game.health + 30);
                        break;
                    case 'weapon':
                        // Increase fire rate temporarily
                        break;
                    case 'shield':
                        // Add temporary shield
                        break;
                }
            }

            render(ctx) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);

                // Powerup symbol
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x + 12, this.y + 5, 6, 20);
                ctx.fillRect(this.x + 5, this.y + 12, 20, 6);
            }
        }

        // Particle class
        class Particle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 6;
                this.vy = (Math.random() - 0.5) * 6;
                this.life = 40;
                this.maxLife = 40;
                this.size = Math.random() * 4 + 2;
            }

            update(deltaTime) {
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
                this.size *= 0.95;
            }

            render(ctx) {
                const alpha = this.life / this.maxLife;
                ctx.fillStyle = `rgba(255, 255, 0, ${alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Initialize game
        let game = null;

        function startNewGame() {
            console.log("=== STARTING NEW GAME ===");
            console.log(`Current game instance exists: ${!!game}`);
            console.log(`Current game running: ${game ? game.gameRunning : 'N/A'}`);
            
            // Stop existing game if running and save statistics
            if (game && game.gameRunning) {
                console.log("Stopping existing game and saving statistics...");
                console.log(`Game stats before saving - Score: ${game.score}, Level: ${game.level}, Enemies Killed: ${game.enemiesKilled}`);
                game.gameRunning = false;
                game.saveStatistics(true); // Previous game is ending
            } else {
                console.log("No running game to save statistics from");
            }
            
            // Stop all sounds from previous game instance
            if (game) {
                game.stopMusic();
                // Stop all SFX by resetting them
                if (game.audio && game.audio.sfx) {
                    Object.keys(game.audio.sfx).forEach(key => {
                        if (game.audio.sfx[key]) {
                            game.audio.sfx[key].pause();
                            game.audio.sfx[key].currentTime = 0;
                        }
                    });
                }
            }
            
            // Reset UI elements to initial state
            // document.getElementById('score').textContent = 'Score: 0';
            // document.getElementById('level').textContent = 'Level: 1';
            // document.getElementById('healthFill').style.width = '100%';
            // document.getElementById('enemiesLeft').textContent = 'Progress: 0/0 (0%)';
            
            // Create new game instance
            game = new SpaceShooterGame();
            window.game = game; // Make game globally accessible
            
            // FIXED: Expose pauseMusic and resumeMusic globally for ad wrapper
            window.pauseMusic = function() {
                if (window.game && window.game.pauseMusic) {
                    window.game.pauseMusic();
                }
            };
            window.resumeMusic = function() {
                if (window.game && window.game.resumeMusic) {
                    window.game.resumeMusic();
                }
            };
            
            game.start();
            console.log("=== NEW GAME STARTED ===");
        }

        // Enhanced Fullscreen functions for mobile - keeps buttons in fullscreen
        function toggleFullscreen() {
            const gameSection = document.getElementById('gameSection');
            
            // Check if already in fullscreen
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Try to make game section fullscreen (keeps buttons inside)
                if (gameSection.requestFullscreen) {
                    gameSection.requestFullscreen().catch(err => {
                        tryDocumentFullscreen();
                    });
                } else if (gameSection.webkitRequestFullscreen) {
                    gameSection.webkitRequestFullscreen().catch(err => {
                        tryDocumentFullscreen();
                    });
                } else if (gameSection.mozRequestFullScreen) {
                    gameSection.mozRequestFullScreen().catch(err => {
                        tryDocumentFullscreen();
                    });
                } else if (gameSection.msRequestFullscreen) {
                    gameSection.msRequestFullscreen().catch(err => {
                        tryDocumentFullscreen();
                    });
                } else {
                    tryDocumentFullscreen();
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(err => {});
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen().catch(err => {});
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen().catch(err => {});
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen().catch(err => {});
                }
            }
        }

        function tryDocumentFullscreen() {
            const elem = document.documentElement;
            
            // Fallback to document fullscreen
            if (elem.requestFullscreen) {
                elem.requestFullscreen().catch(err => {
                    tryMobileFullscreen();
                });
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen().catch(err => {
                    tryMobileFullscreen();
                });
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen().catch(err => {
                    tryMobileFullscreen();
                });
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen().catch(err => {
                    tryMobileFullscreen();
                });
            } else {
                tryMobileFullscreen();
            }
        }

        function tryMobileFullscreen() {
            // Mobile-specific fullscreen approach
            const canvas = document.getElementById('gameCanvas');
            if (canvas) {
                // Try to make canvas fullscreen
                if (canvas.webkitRequestFullscreen) {
                    canvas.webkitRequestFullscreen();
                } else if (canvas.mozRequestFullScreen) {
                    canvas.mozRequestFullScreen();
                } else if (canvas.msRequestFullscreen) {
                    canvas.msRequestFullscreen();
                } else {
                    // Fallback: Hide browser UI elements
                    hideMobileUI();
                }
            } else {
                hideMobileUI();
            }
        }

        function hideMobileUI() {
            // Silent mobile UI hiding - no notifications
            document.documentElement.style.width = '100vw';
            document.documentElement.style.height = '100vh';
            document.documentElement.style.margin = '0';
            document.documentElement.style.padding = '0';
            document.documentElement.style.overflow = 'hidden';
            
            document.body.style.position = 'fixed';
            document.body.style.top = '0';
            document.body.style.left = '0';
            document.body.style.width = '100vw';
            document.body.style.height = '100vh';
            document.body.style.margin = '0';
            document.body.style.padding = '0';
            document.body.style.overflow = 'hidden';
        }

        function showGameMenu() {
            console.log("showGameMenu called!");
            
            // Save current game statistics before pausing
            if (window.game && window.game.gameRunning) {
                console.log("Saving game statistics before showing menu...");
                window.game.saveStatistics(false); // Game is not ending, just pausing
            }
            
            // Stop the game
            if (window.game) {
                // Remember that game was running when opening menu
                window.wasGameRunningBeforeMenu = !!window.game.gameRunning;
                window.game.gameRunning = false;
            }
            
            // Exit fullscreen first to show menu properly
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                 document.mozFullScreenElement || document.msFullscreenElement);
            
            console.log("Is fullscreen:", isFullscreen);
            
            if (isFullscreen) {
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(err => console.log("Exit fullscreen error:", err));
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen().catch(err => console.log("Exit fullscreen error:", err));
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen().catch(err => console.log("Exit fullscreen error:", err));
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen().catch(err => console.log("Exit fullscreen error:", err));
                }
            }
            
            // Hide game section
            const gameSection = document.getElementById('gameSection');
            if (gameSection) {
                gameSection.style.display = 'none';
                console.log("Game section hidden");
            }
            
            // Show menu overlay
            const menuOverlay = document.getElementById('menuOverlay');
            if (menuOverlay) {
                menuOverlay.style.display = 'flex';
                menuOverlay.style.zIndex = '999999';
                menuOverlay.style.position = 'fixed';
                menuOverlay.style.top = '0';
                menuOverlay.style.left = '0';
                menuOverlay.style.width = '100vw';
                menuOverlay.style.height = '100vh';
                menuOverlay.style.visibility = 'visible';
                menuOverlay.style.opacity = '1';
                
                console.log("Menu overlay shown");
                
                // Return menu to body if it was in fullscreen element
                if (menuOverlay.parentNode !== document.body) {
                    document.body.appendChild(menuOverlay);
                    console.log("Menu returned to body");
                }
            } else {
                console.log("Menu overlay not found!");
            }
            
            // Show in-game menu with restart button
            setTimeout(() => {
                console.log("Calling MenuUI.showInGameMenu()");
                MenuUI.showInGameMenu();
            }, 100);
        }

        function closeGame() {
            console.log("Close game - returning to home page");
            
            // FIXED: Show midroll ad when cross button is clicked
            if (window.game && window.game.gameRunning) {
                console.log("Space Battle: Cross button clicked - showing midroll ad");
                showAd();
            }
            
            // Stop the game if running
            if (window.game) {
                // Stop game
                window.game.gameRunning = false;
                
                // Stop music completely
                if (window.game.stopMusic) {
                    window.game.stopMusic();
                    console.log("Music stopped");
                }
                
                // Stop all SFX sounds
                if (window.game.audio && window.game.audio.sfx) {
                    Object.keys(window.game.audio.sfx).forEach(key => {
                        if (window.game.audio.sfx[key]) {
                            window.game.audio.sfx[key].pause();
                            window.game.audio.sfx[key].currentTime = 0;
                        }
                    });
                    console.log("All SFX stopped");
                }
                
                // Save statistics before closing
                if (window.game.saveStatistics) {
                    window.game.saveStatistics(false);
                }
            }
            
            // Remove any game over popups
            const popup = document.getElementById('gameOverPopup');
            if (popup) {
                popup.remove();
            }
            
            // Hide game section
            const gameSection = document.getElementById('gameSection');
            if (gameSection) {
                gameSection.style.display = 'none';
                gameSection.classList.remove('active');
            }
            
            // Exit fullscreen if active
            if (document.fullscreenElement || document.webkitFullscreenElement || 
                document.mozFullScreenElement || document.msFullscreenElement) {
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(err => console.log("Exit fullscreen error:", err));
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen().catch(err => console.log("Exit fullscreen error:", err));
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen().catch(err => console.log("Exit fullscreen error:", err));
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen().catch(err => console.log("Exit fullscreen error:", err));
                }
            }
            
            // // Reset UI elements to initial state
            // const scoreEl = document.getElementById('score');
            // const levelEl = document.getElementById('level');
            // const healthFill = document.getElementById('healthFill');
            // const enemiesLeft = document.getElementById('enemiesLeft');
            
            // if (scoreEl) scoreEl.textContent = 'Score: 0';
            // if (levelEl) levelEl.textContent = 'Level: 1';
            // if (healthFill) healthFill.style.width = '100%';
            // if (enemiesLeft) enemiesLeft.textContent = 'Progress: 0/0 (0%)';
            
            // Show menu overlay
            const menuOverlay = document.getElementById('menuOverlay');
            if (menuOverlay) {
                menuOverlay.style.display = 'flex';
                menuOverlay.style.zIndex = '999999';
                menuOverlay.style.position = 'fixed';
                menuOverlay.style.top = '0';
                menuOverlay.style.left = '0';
                menuOverlay.style.width = '100vw';
                menuOverlay.style.height = '100vh';
                menuOverlay.style.visibility = 'visible';
                menuOverlay.style.opacity = '1';
                
                if (menuOverlay.parentNode !== document.body) {
                    document.body.appendChild(menuOverlay);
                }
            }
            
            // Show main menu (home page)
            setTimeout(() => {
                if (typeof MenuUI !== 'undefined' && MenuUI && MenuUI.showMainMenu) {
                    MenuUI.showMainMenu();
                    console.log("Returned to home page");
                }
            }, 100);
        }

        // Add global access to MenuUI
        window.MenuUI = MenuUI;

        // Enhanced mobile fullscreen event listeners
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                 document.mozFullScreenElement || document.msFullscreenElement);
            
            if (isFullscreen) {
                // Entered fullscreen - ensure proper sizing for mobile
                const gameSection = document.getElementById('gameSection');
                
                // If game section is in fullscreen, ensure it covers everything
                if (gameSection && (gameSection === document.fullscreenElement || 
                    gameSection === document.webkitFullscreenElement ||
                    gameSection === document.mozFullScreenElement ||
                    gameSection === document.msFullscreenElement)) {
                    
                    gameSection.style.width = '100vw';
                    gameSection.style.height = '100vh';
                    gameSection.style.margin = '0';
                    gameSection.style.padding = '0';
                    gameSection.style.overflow = 'hidden';
                    gameSection.style.position = 'fixed';
                    gameSection.style.top = '0';
                    gameSection.style.left = '0';
                    
                    // Ensure canvas covers entire screen
                    const canvas = document.getElementById('gameCanvas');
                    if (canvas) {
                        canvas.style.width = '100vw';
                        canvas.style.height = '100vh';
                        canvas.style.position = 'fixed';
                        canvas.style.top = '0';
                        canvas.style.left = '0';
                        canvas.style.margin = '0';
                        canvas.style.padding = '0';
                    }
                    
                    // Ensure buttons stay visible in fullscreen
                    const buttons = gameSection.querySelectorAll('.control-btn');
                    buttons.forEach(btn => {
                        btn.style.position = 'fixed';
                        btn.style.zIndex = '1000';
                    });
                    
                    // Ensure menu overlay is accessible in fullscreen
                    const menuOverlay = document.getElementById('menuOverlay');
                    if (menuOverlay) {
                        menuOverlay.style.zIndex = '999999';
                        menuOverlay.style.position = 'fixed';
                        menuOverlay.style.top = '0';
                        menuOverlay.style.left = '0';
                        menuOverlay.style.width = '100vw';
                        menuOverlay.style.height = '100vh';
                    }
                } else {
                    // Document fullscreen fallback
                    document.documentElement.style.width = '100vw';
                    document.documentElement.style.height = '100vh';
                    document.documentElement.style.margin = '0';
                    document.documentElement.style.padding = '0';
                    document.documentElement.style.overflow = 'hidden';
                    
                    document.body.style.width = '100vw';
                    document.body.style.height = '100vh';
                    document.body.style.margin = '0';
                    document.body.style.padding = '0';
                    document.body.style.overflow = 'hidden';
                    document.body.style.position = 'fixed';
                    document.body.style.top = '0';
                    document.body.style.left = '0';
                }
                
                // Silent mobile optimizations - no notifications
                if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    // Silent mobile fullscreen
                    setTimeout(() => {
                        document.body.style.webkitTransform = 'translate3d(0,0,0)';
                        document.body.style.transform = 'translate3d(0,0,0)';
                    }, 50);
                }
                
                // Resize canvas if game is running
                if (window.game && window.game.initializeCanvas) {
                    setTimeout(() => {
                        window.game.initializeCanvas();
                    }, 200);
                }
            } else {
                // Exited fullscreen - restore normal sizing
                document.documentElement.style.width = '100%';
                document.documentElement.style.height = '100%';
                document.documentElement.style.overflow = 'hidden';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                document.body.style.position = 'fixed';
                
                // Restore game section
                const gameSection = document.getElementById('gameSection');
                if (gameSection) {
                    gameSection.style.width = '100%';
                    gameSection.style.height = '100%';
                    gameSection.style.position = 'fixed';
                }
            }
        }

        // Mobile-specific fullscreen improvements
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // Add touch event to prevent zoom
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Prevent double-tap zoom
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Hide address bar on mobile
            window.addEventListener('load', function() {
                setTimeout(function() {
                    window.scrollTo(0, 1);
                }, 0);
            });
        }
    </script>
    
    <!-- JioGames SDK Integration -->
    <script src="jiogames_sp_wrapper.js"></script>
    <script>
        // Console logging for smartphone SDK
        console.log("Space Battle - Smartphone SDK initialized");
        window.addEventListener('load', function() {
            console.log("Space Battle Smartphone - Page Loaded");
            
            // Load banner immediately on page load
            try{
                loadBanner();
                console.log("Space Battle: Banner loading started");
                // Show banner after it loads
                setTimeout(function(){ 
                    showBanner(); 
                    setBottomBanner(); 
                }, 1000);
            } catch(e) { console.log(e); }
            
            // Note: cacheAd() will be called at start game (mid-roll) and rewarded at game over
        });
    </script>
</body>
</html>
